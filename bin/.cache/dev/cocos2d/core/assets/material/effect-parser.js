
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/assets/material/effect-parser.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

exports.__esModule = true;
exports.parseEffect = parseEffect;

var _pass = _interopRequireDefault(require("../../../renderer/core/pass"));

var _types = require("../../../renderer/types");

var _enums = _interopRequireDefault(require("../../../renderer/enums"));

var _effect = _interopRequireDefault(require("./effect"));

var _technique = _interopRequireDefault(require("../../../renderer/core/technique"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function getInvolvedProgram(programName) {
  var lib = cc.renderer._forward._programLib;
  return lib.getTemplate(programName);
} // extract properties from each passes and check whether properties is defined but not used.


function parseProperties(effectAsset, passJson) {
  var propertiesJson = passJson.properties || {};
  var program = getInvolvedProgram(passJson.program); // check whether properties are defined in the shaders 

  var _loop = function _loop(prop) {
    var uniformInfo = program.uniforms.find(function (u) {
      return u.name === prop;
    }); // the property is not defined in all the shaders used in techs

    if (!uniformInfo) {
      cc.warnID(9107, effectAsset.name, prop);
      return "continue";
    }
  };

  for (var prop in propertiesJson) {
    var _ret = _loop(prop);

    if (_ret === "continue") continue;
  } // create properties


  var properties = {};
  program.uniforms.forEach(function (u) {
    var name = u.name,
        prop = properties[name] = Object.assign({}, u),
        propInfo = propertiesJson[name];
    var value;

    if (propInfo) {
      if (propInfo.type === _enums["default"].PARAM_TEXTURE_2D) {
        value = null;
      } else if (propInfo.type === _enums["default"].PARAM_INT || propInfo.type === _enums["default"].PARAM_FLOAT) {
        value = Array.isArray(propInfo.value) ? propInfo.value[0] : propInfo.value;
      } else {
        value = new Float32Array(propInfo.value);
      }
    } else {
      value = _types.enums2default[u.type];
    }

    if (value === undefined) {
      value = null;
    }

    prop.value = value;
  });
  return properties;
}

;

function passDefines(pass) {
  var defines = {};
  var program = getInvolvedProgram(pass.program);
  program.defines.forEach(function (d) {
    defines[d.name] = _types.enums2default[d.type];
  });
  return defines;
}

function parseTechniques(effectAsset) {
  var techNum = effectAsset.techniques.length;
  var techniques = new Array(techNum);

  for (var j = 0; j < techNum; ++j) {
    var tech = effectAsset.techniques[j];
    var techName = tech.name || j;
    var passNum = tech.passes.length;
    var passes = new Array(passNum);

    for (var k = 0; k < passNum; ++k) {
      var pass = tech.passes[k];
      var passName = pass.name || k;
      var detailName = effectAsset.name + "-" + techName + "-" + passName;
      var stage = pass.stage || 'opaque';
      var properties = parseProperties(effectAsset, pass);
      var defines = passDefines(pass);
      var newPass = passes[k] = new _pass["default"](passName, detailName, pass.program, stage, properties, defines); // rasterizer state

      if (pass.rasterizerState) {
        newPass.setCullMode(pass.rasterizerState.cullMode);
      } // blend state


      var blendState = pass.blendState && pass.blendState.targets[0];

      if (blendState) {
        newPass.setBlend(blendState.blend, blendState.blendEq, blendState.blendSrc, blendState.blendDst, blendState.blendAlphaEq, blendState.blendSrcAlpha, blendState.blendDstAlpha, blendState.blendColor);
      } // depth stencil state


      var depthStencilState = pass.depthStencilState;

      if (depthStencilState) {
        newPass.setDepth(depthStencilState.depthTest, depthStencilState.depthWrite, depthStencilState.depthFunc);
        newPass.setStencilFront(depthStencilState.stencilTest, depthStencilState.stencilFuncFront, depthStencilState.stencilRefFront, depthStencilState.stencilMaskFront, depthStencilState.stencilFailOpFront, depthStencilState.stencilZFailOpFront, depthStencilState.stencilZPassOpFront, depthStencilState.stencilWriteMaskFront);
        newPass.setStencilBack(depthStencilState.stencilTest, depthStencilState.stencilFuncBack, depthStencilState.stencilRefBack, depthStencilState.stencilMaskBack, depthStencilState.stencilFailOpBack, depthStencilState.stencilZFailOpBack, depthStencilState.stencilZPassOpBack, depthStencilState.stencilWriteMaskBack);
      }
    }

    techniques[j] = new _technique["default"](techName, passes);
  }

  return techniques;
}

;

function parseEffect(effect) {
  var techniques = parseTechniques(effect);
  return new _effect["default"](effect.name, techniques, 0, effect);
}

;

if (CC_EDITOR) {
  // inspector only need properties defined in CCEffect
  _effect["default"].parseForInspector = function (effectAsset) {
    return effectAsset.techniques.map(function (tech, techIdx) {
      var passes = tech.passes.map(function (pass, passIdx) {
        var program = getInvolvedProgram(pass.program);
        var newProps = {};
        var props = pass.properties;

        var _loop2 = function _loop2(name) {
          newProps[name] = (0, _types.getInspectorProps)(props[name]);
          var u = program.uniforms.find(function (u) {
            return u.name === name;
          });
          newProps[name].defines = u.defines || [];
        };

        for (var name in props) {
          _loop2(name);
        }

        var newDefines = {};
        program.defines.map(function (def) {
          newDefines[def.name] = (0, _types.getInspectorProps)(def);
        });
        return {
          name: pass.name || passIdx,
          props: newProps,
          defines: newDefines
        };
      });
      return {
        name: tech.name || techIdx,
        passes: passes
      };
    });
  };
}
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXZcXGNvY29zMmRcXGNvcmVcXGFzc2V0c1xcbWF0ZXJpYWxcXGVmZmVjdC1wYXJzZXIudHMiXSwibmFtZXMiOlsiZ2V0SW52b2x2ZWRQcm9ncmFtIiwicHJvZ3JhbU5hbWUiLCJsaWIiLCJjYyIsInJlbmRlcmVyIiwiX2ZvcndhcmQiLCJfcHJvZ3JhbUxpYiIsImdldFRlbXBsYXRlIiwicGFyc2VQcm9wZXJ0aWVzIiwiZWZmZWN0QXNzZXQiLCJwYXNzSnNvbiIsInByb3BlcnRpZXNKc29uIiwicHJvcGVydGllcyIsInByb2dyYW0iLCJwcm9wIiwidW5pZm9ybUluZm8iLCJ1bmlmb3JtcyIsImZpbmQiLCJ1IiwibmFtZSIsIndhcm5JRCIsImZvckVhY2giLCJPYmplY3QiLCJhc3NpZ24iLCJwcm9wSW5mbyIsInZhbHVlIiwidHlwZSIsImVudW1zIiwiUEFSQU1fVEVYVFVSRV8yRCIsIlBBUkFNX0lOVCIsIlBBUkFNX0ZMT0FUIiwiQXJyYXkiLCJpc0FycmF5IiwiRmxvYXQzMkFycmF5IiwiZW51bXMyZGVmYXVsdCIsInVuZGVmaW5lZCIsInBhc3NEZWZpbmVzIiwicGFzcyIsImRlZmluZXMiLCJkIiwicGFyc2VUZWNobmlxdWVzIiwidGVjaE51bSIsInRlY2huaXF1ZXMiLCJsZW5ndGgiLCJqIiwidGVjaCIsInRlY2hOYW1lIiwicGFzc051bSIsInBhc3NlcyIsImsiLCJwYXNzTmFtZSIsImRldGFpbE5hbWUiLCJzdGFnZSIsIm5ld1Bhc3MiLCJQYXNzIiwicmFzdGVyaXplclN0YXRlIiwic2V0Q3VsbE1vZGUiLCJjdWxsTW9kZSIsImJsZW5kU3RhdGUiLCJ0YXJnZXRzIiwic2V0QmxlbmQiLCJibGVuZCIsImJsZW5kRXEiLCJibGVuZFNyYyIsImJsZW5kRHN0IiwiYmxlbmRBbHBoYUVxIiwiYmxlbmRTcmNBbHBoYSIsImJsZW5kRHN0QWxwaGEiLCJibGVuZENvbG9yIiwiZGVwdGhTdGVuY2lsU3RhdGUiLCJzZXREZXB0aCIsImRlcHRoVGVzdCIsImRlcHRoV3JpdGUiLCJkZXB0aEZ1bmMiLCJzZXRTdGVuY2lsRnJvbnQiLCJzdGVuY2lsVGVzdCIsInN0ZW5jaWxGdW5jRnJvbnQiLCJzdGVuY2lsUmVmRnJvbnQiLCJzdGVuY2lsTWFza0Zyb250Iiwic3RlbmNpbEZhaWxPcEZyb250Iiwic3RlbmNpbFpGYWlsT3BGcm9udCIsInN0ZW5jaWxaUGFzc09wRnJvbnQiLCJzdGVuY2lsV3JpdGVNYXNrRnJvbnQiLCJzZXRTdGVuY2lsQmFjayIsInN0ZW5jaWxGdW5jQmFjayIsInN0ZW5jaWxSZWZCYWNrIiwic3RlbmNpbE1hc2tCYWNrIiwic3RlbmNpbEZhaWxPcEJhY2siLCJzdGVuY2lsWkZhaWxPcEJhY2siLCJzdGVuY2lsWlBhc3NPcEJhY2siLCJzdGVuY2lsV3JpdGVNYXNrQmFjayIsIlRlY2huaXF1ZSIsInBhcnNlRWZmZWN0IiwiZWZmZWN0IiwiRWZmZWN0IiwiQ0NfRURJVE9SIiwicGFyc2VGb3JJbnNwZWN0b3IiLCJtYXAiLCJ0ZWNoSWR4IiwicGFzc0lkeCIsIm5ld1Byb3BzIiwicHJvcHMiLCJuZXdEZWZpbmVzIiwiZGVmIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxTQUFTQSxrQkFBVCxDQUE2QkMsV0FBN0IsRUFBMEM7QUFDdEMsTUFBSUMsR0FBRyxHQUFHQyxFQUFFLENBQUNDLFFBQUgsQ0FBWUMsUUFBWixDQUFxQkMsV0FBL0I7QUFDQSxTQUFPSixHQUFHLENBQUNLLFdBQUosQ0FBZ0JOLFdBQWhCLENBQVA7QUFDSCxFQUVEOzs7QUFDQSxTQUFTTyxlQUFULENBQTBCQyxXQUExQixFQUF1Q0MsUUFBdkMsRUFBaUQ7QUFDN0MsTUFBSUMsY0FBYyxHQUFHRCxRQUFRLENBQUNFLFVBQVQsSUFBdUIsRUFBNUM7QUFDQSxNQUFJQyxPQUFPLEdBQUdiLGtCQUFrQixDQUFDVSxRQUFRLENBQUNHLE9BQVYsQ0FBaEMsQ0FGNkMsQ0FJN0M7O0FBSjZDLDZCQUtwQ0Ms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RixJQUFELENBQXZCLENBQWpCO0FBRUEsY0FBSUQsQ0FBQyxHQUFHTCxPQUFPLENBQUNHLFFBQVIsQ0FBaUJDLElBQWpCLENBQXNCLFVBQUFDLENBQUM7QUFBQSxtQkFBSUEsQ0FBQyxDQUFDQyxJQUFGLEtBQVdBLElBQWY7QUFBQSxXQUF2QixDQUFSO0FBQ0FpRixVQUFBQSxRQUFRLENBQUNqRixJQUFELENBQVIsQ0FBZW1CLE9BQWYsR0FBeUJwQixDQUFDLENBQUNvQixPQUFGLElBQWEsRUFBdEM7QUFUd0M7O0FBSzVDLGFBQUssSUFBSW5CLElBQVQsSUFBaUJrRixLQUFqQixFQUF3QjtBQUFBLGlCQUFmbEYsSUFBZTtBQUt2Qjs7QUFFRCxZQUFJbUYsVUFBVSxHQUFHLEVBQWpCO0FBQ0F6RixRQUFBQSxPQUFPLENBQUN5QixPQUFSLENBQWdCMkQsR0FBaEIsQ0FBb0IsVUFBQU0sR0FBRyxFQUFJO0FBQ3ZCRCxVQUFBQSxVQUFVLENBQUNDLEdBQUcsQ0FBQ3BGLElBQUwsQ0FBVixHQUF1Qiw4QkFBa0JvRixHQUFsQixDQUF2QjtBQUNILFNBRkQ7QUFJQSxlQUFPO0FBQ0hwRixVQUFBQSxJQUFJLEVBQUVrQixJQUFJLENBQUNsQixJQUFMLElBQWFnRixPQURoQjtBQUVIRSxVQUFBQSxLQUFLLEVBQUVELFFBRko7QUFHSDlELFVBQUFBLE9BQU8sRUFBRWdFO0FBSE4sU0FBUDtBQUtILE9BdEJZLENBQWI7QUF3QkEsYUFBTztBQUNIbkYsUUFBQUEsSUFBSSxFQUFFMEIsSUFBSSxDQUFDMUIsSUFBTCxJQUFhK0UsT0FEaEI7QUFFSGxELFFBQUFBLE1BQU0sRUFBRUE7QUFGTCxPQUFQO0FBSUgsS0E3Qk0sQ0FBUDtBQThCSCxHQS9CRDtBQWdDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQYXNzIGZyb20gJy4uLy4uLy4uL3JlbmRlcmVyL2NvcmUvcGFzcyc7XHJcbmltcG9ydCB7IGdldEluc3BlY3RvclByb3BzLCBlbnVtczJkZWZhdWx0IH0gZnJvbSAnLi4vLi4vLi4vcmVuZGVyZXIvdHlwZXMnO1xyXG5pbXBvcnQgZW51bXMgZnJvbSAnLi4vLi4vLi4vcmVuZGVyZXIvZW51bXMnO1xyXG5pbXBvcnQgRWZmZWN0IGZyb20gJy4vZWZmZWN0JztcclxuaW1wb3J0IFRlY2huaXF1ZSBmcm9tICcuLi8uLi8uLi9yZW5kZXJlci9jb3JlL3RlY2huaXF1ZSc7XHJcblxyXG5mdW5jdGlvbiBnZXRJbnZvbHZlZFByb2dyYW0gKHByb2dyYW1OYW1lKSB7XHJcbiAgICBsZXQgbGliID0gY2MucmVuZGVyZXIuX2ZvcndhcmQuX3Byb2dyYW1MaWI7XHJcbiAgICByZXR1cm4gbGliLmdldFRlbXBsYXRlKHByb2dyYW1OYW1lKTtcclxufVxyXG5cclxuLy8gZXh0cmFjdCBwcm9wZXJ0aWVzIGZyb20gZWFjaCBwYXNzZXMgYW5kIGNoZWNrIHdoZXRoZXIgcHJvcGVydGllcyBpcyBkZWZpbmVkIGJ1dCBub3QgdXNlZC5cclxuZnVuY3Rpb24gcGFyc2VQcm9wZXJ0aWVzIChlZmZlY3RBc3NldCwgcGFzc0pzb24pIHtcclxuICAgIGxldCBwcm9wZXJ0aWVzSnNvbiA9IHBhc3NKc29uLnByb3BlcnRpZXMgfHwge307XHJcbiAgICBsZXQgcHJvZ3JhbSA9IGdldEludm9sdmVkUHJvZ3JhbShwYXNzSnNvbi5wcm9ncmFtKTtcclxuXHJcbiAgICAvLyBjaGVjayB3aGV0aGVyIHByb3BlcnRpZXMgYXJlIGRlZmluZWQgaW4gdGhlIHNoYWRlcnMgXHJcbiAgICBmb3IgKGxldCBwcm9wIGluIHByb3BlcnRpZXNKc29uKSB7XHJcbiAgICAgICAgbGV0IHVuaWZvcm1JbmZvID0gcHJvZ3JhbS51bmlmb3Jtcy5maW5kKHUgPT4gdS5uYW1lID09PSBwcm9wKTtcclxuICAgICAgICAvLyB0aGUgcHJvcGVydHkgaXMgbm90IGRlZmluZWQgaW4gYWxsIHRoZSBzaGFkZXJzIHVzZWQgaW4gdGVjaHNcclxuICAgICAgICBpZiAoIXVuaWZvcm1JbmZvKSB7XHJcbiAgICAgICAgICAgIGNjLndhcm5JRCg5MTA3LCBlZmZlY3RBc3NldC5uYW1lLCBwcm9wKTtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGNyZWF0ZSBwcm9wZXJ0aWVzXHJcbiAgICBsZXQgcHJvcGVydGllcyA9IHt9O1xyXG4gICAgcHJvZ3JhbS51bmlmb3Jtcy5mb3JFYWNoKHUgPT4ge1xyXG4gICAgICAgIGxldCBuYW1lID0gdS5uYW1lLFxyXG4gICAgICAgICAgICBwcm9wID0gcHJvcGVydGllc1tuYW1lXSA9IE9iamVjdC5hc3NpZ24oe30sIHUpLFxyXG4gICAgICAgICAgICBwcm9wSW5mbyA9IHByb3BlcnRpZXNKc29uW25hbWVdO1xyXG5cclxuICAgICAgICBsZXQgdmFsdWU7XHJcbiAgICAgICAgaWYgKHByb3BJbmZvKSB7XHJcbiAgICAgICAgICAgIGlmIChwcm9wSW5mby50eXBlID09PSBlbnVtcy5QQVJBTV9URVhUVVJFXzJEKSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAocHJvcEluZm8udHlwZSA9PT0gZW51bXMuUEFSQU1fSU5UIHx8IHByb3BJbmZvLnR5cGUgPT09IGVudW1zLlBBUkFNX0ZMT0FUKSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IEFycmF5LmlzQXJyYXkocHJvcEluZm8udmFsdWUpID8gcHJvcEluZm8udmFsdWVbMF0gOiBwcm9wSW5mby52YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gbmV3IEZsb2F0MzJBcnJheShwcm9wSW5mby52YWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gZW51bXMyZGVmYXVsdFt1LnR5cGVdO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdmFsdWUgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJvcC52YWx1ZSA9IHZhbHVlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHByb3BlcnRpZXM7XHJcbn07XHJcblxyXG5mdW5jdGlvbiBwYXNzRGVmaW5lcyAocGFzcykge1xyXG4gICAgbGV0IGRlZmluZXMgPSB7fTtcclxuICAgIGxldCBwcm9ncmFtID0gZ2V0SW52b2x2ZWRQcm9ncmFtKHBhc3MucHJvZ3JhbSk7XHJcbiAgICBwcm9ncmFtLmRlZmluZXMuZm9yRWFjaChkID0+IHtcclxuICAgICAgICBkZWZpbmVzW2QubmFtZV0gPSBlbnVtczJkZWZhdWx0W2QudHlwZV07XHJcbiAgICB9KVxyXG4gICAgcmV0dXJuIGRlZmluZXM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlVGVjaG5pcXVlcyAoZWZmZWN0QXNzZXQpIHtcclxuICAgIGxldCB0ZWNoTnVtID0gZWZmZWN0QXNzZXQudGVjaG5pcXVlcy5sZW5ndGg7XHJcbiAgICBsZXQgdGVjaG5pcXVlcyA9IG5ldyBBcnJheSh0ZWNoTnVtKTtcclxuICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGVjaE51bTsgKytqKSB7XHJcbiAgICAgICAgbGV0IHRlY2ggPSBlZmZlY3RBc3NldC50ZWNobmlxdWVzW2pdO1xyXG4gICAgICAgIGxldCB0ZWNoTmFtZSA9IHRlY2gubmFtZSB8fCBqO1xyXG5cclxuICAgICAgICBsZXQgcGFzc051bSA9IHRlY2gucGFzc2VzLmxlbmd0aDtcclxuICAgICAgICBsZXQgcGFzc2VzID0gbmV3IEFycmF5KHBhc3NOdW0pO1xyXG4gICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgcGFzc051bTsgKytrKSB7XHJcbiAgICAgICAgICAgIGxldCBwYXNzID0gdGVjaC5wYXNzZXNba107XHJcblxyXG4gICAgICAgICAgICBsZXQgcGFzc05hbWUgPSBwYXNzLm5hbWUgfHwgaztcclxuICAgICAgICAgICAgbGV0IGRldGFpbE5hbWUgPSBgJHtlZmZlY3RBc3NldC5uYW1lfS0ke3RlY2hOYW1lfS0ke3Bhc3NOYW1lfWA7XHJcbiAgICAgICAgICAgIGxldCBzdGFnZSA9IHBhc3Muc3RhZ2UgfHwgJ29wYXF1ZSc7XHJcbiAgICAgICAgICAgIGxldCBwcm9wZXJ0aWVzID0gcGFyc2VQcm9wZXJ0aWVzKGVmZmVjdEFzc2V0LCBwYXNzKTtcclxuICAgICAgICAgICAgbGV0IGRlZmluZXMgPSBwYXNzRGVmaW5lcyhwYXNzKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBuZXdQYXNzID0gcGFzc2VzW2tdID0gbmV3IFBhc3MocGFzc05hbWUsIGRldGFpbE5hbWUsIHBhc3MucHJvZ3JhbSwgc3RhZ2UsIHByb3BlcnRpZXMsIGRlZmluZXMpO1xyXG5cclxuICAgICAgICAgICAgLy8gcmFzdGVyaXplciBzdGF0ZVxyXG4gICAgICAgICAgICBpZiAocGFzcy5yYXN0ZXJpemVyU3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIG5ld1Bhc3Muc2V0Q3VsbE1vZGUocGFzcy5yYXN0ZXJpemVyU3RhdGUuY3VsbE1vZGUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBibGVuZCBzdGF0ZVxyXG4gICAgICAgICAgICBsZXQgYmxlbmRTdGF0ZSA9IHBhc3MuYmxlbmRTdGF0ZSAmJiBwYXNzLmJsZW5kU3RhdGUudGFyZ2V0c1swXTtcclxuICAgICAgICAgICAgaWYgKGJsZW5kU3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIG5ld1Bhc3Muc2V0QmxlbmQoYmxlbmRTdGF0ZS5ibGVuZCwgYmxlbmRTdGF0ZS5ibGVuZEVxLCBibGVuZFN0YXRlLmJsZW5kU3JjLFxyXG4gICAgICAgICAgICAgICAgICAgIGJsZW5kU3RhdGUuYmxlbmREc3QsIGJsZW5kU3RhdGUuYmxlbmRBbHBoYUVxLCBibGVuZFN0YXRlLmJsZW5kU3JjQWxwaGEsIGJsZW5kU3RhdGUuYmxlbmREc3RBbHBoYSwgYmxlbmRTdGF0ZS5ibGVuZENvbG9yKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gZGVwdGggc3RlbmNpbCBzdGF0ZVxyXG4gICAgICAgICAgICBsZXQgZGVwdGhTdGVuY2lsU3RhdGUgPSBwYXNzLmRlcHRoU3RlbmNpbFN0YXRlO1xyXG4gICAgICAgICAgICBpZiAoZGVwdGhTdGVuY2lsU3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIG5ld1Bhc3Muc2V0RGVwdGgoZGVwdGhTdGVuY2lsU3RhdGUuZGVwdGhUZXN0LCBkZXB0aFN0ZW5jaWxTdGF0ZS5kZXB0aFdyaXRlLCBkZXB0aFN0ZW5jaWxTdGF0ZS5kZXB0aEZ1bmMpO1xyXG4gICAgICAgICAgICAgICAgbmV3UGFzcy5zZXRTdGVuY2lsRnJvbnQoZGVwdGhTdGVuY2lsU3RhdGUuc3RlbmNpbFRlc3QsIGRlcHRoU3RlbmNpbFN0YXRlLnN0ZW5jaWxGdW5jRnJvbnQsIGRlcHRoU3RlbmNpbFN0YXRlLnN0ZW5jaWxSZWZGcm9udCwgZGVwdGhTdGVuY2lsU3RhdGUuc3RlbmNpbE1hc2tGcm9udCxcclxuICAgICAgICAgICAgICAgICAgICBkZXB0aFN0ZW5jaWxTdGF0ZS5zdGVuY2lsRmFpbE9wRnJvbnQsIGRlcHRoU3RlbmNpbFN0YXRlLnN0ZW5jaWxaRmFpbE9wRnJvbnQsIGRlcHRoU3RlbmNpbFN0YXRlLnN0ZW5jaWxaUGFzc09wRnJvbnQsIGRlcHRoU3RlbmNpbFN0YXRlLnN0ZW5jaWxXcml0ZU1hc2tGcm9udCk7XHJcbiAgICAgICAgICAgICAgICBuZXdQYXNzLnNldFN0ZW5jaWxCYWNrKGRlcHRoU3RlbmNpbFN0YXRlLnN0ZW5jaWxUZXN0LCBkZXB0aFN0ZW5jaWxTdGF0ZS5zdGVuY2lsRnVuY0JhY2ssIGRlcHRoU3RlbmNpbFN0YXRlLnN0ZW5jaWxSZWZCYWNrLCBkZXB0aFN0ZW5jaWxTdGF0ZS5zdGVuY2lsTWFza0JhY2ssXHJcbiAgICAgICAgICAgICAgICAgICAgZGVwdGhTdGVuY2lsU3RhdGUuc3RlbmNpbEZhaWxPcEJhY2ssIGRlcHRoU3RlbmNpbFN0YXRlLnN0ZW5jaWxaRmFpbE9wQmFjaywgZGVwdGhTdGVuY2lsU3RhdGUuc3RlbmNpbFpQYXNzT3BCYWNrLCBkZXB0aFN0ZW5jaWxTdGF0ZS5zdGVuY2lsV3JpdGVNYXNrQmFjayk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGVjaG5pcXVlc1tqXSA9IG5ldyBUZWNobmlxdWUodGVjaE5hbWUsIHBhc3Nlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRlY2huaXF1ZXM7XHJcbn07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VFZmZlY3QgKGVmZmVjdCkge1xyXG4gICAgbGV0IHRlY2huaXF1ZXMgPSBwYXJzZVRlY2huaXF1ZXMoZWZmZWN0KTtcclxuICAgIHJldHVybiBuZXcgRWZmZWN0KGVmZmVjdC5uYW1lLCB0ZWNobmlxdWVzLCAwLCBlZmZlY3QpO1xyXG59O1xyXG5cclxuaWYgKENDX0VESVRPUikge1xyXG4gICAgLy8gaW5zcGVjdG9yIG9ubHkgbmVlZCBwcm9wZXJ0aWVzIGRlZmluZWQgaW4gQ0NFZmZlY3RcclxuICAgIEVmZmVjdC5wYXJzZUZvckluc3BlY3RvciA9IGZ1bmN0aW9uIChlZmZlY3RBc3NldCkge1xyXG4gICAgICAgIHJldHVybiBlZmZlY3RBc3NldC50ZWNobmlxdWVzLm1hcCgodGVjaCwgdGVjaElkeCkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcGFzc2VzID0gdGVjaC5wYXNzZXMubWFwKChwYXNzLCBwYXNzSWR4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcHJvZ3JhbSA9IGdldEludm9sdmVkUHJvZ3JhbShwYXNzLnByb2dyYW0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBuZXdQcm9wcyA9IHt9O1xyXG4gICAgICAgICAgICAgICAgbGV0IHByb3BzID0gcGFzcy5wcm9wZXJ0aWVzO1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgbmFtZSBpbiBwcm9wcykge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld1Byb3BzW25hbWVdID0gZ2V0SW5zcGVjdG9yUHJvcHMocHJvcHNbbmFtZV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGxldCB1ID0gcHJvZ3JhbS51bmlmb3Jtcy5maW5kKHUgPT4gdS5uYW1lID09PSBuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBuZXdQcm9wc1tuYW1lXS5kZWZpbmVzID0gdS5kZWZpbmVzIHx8IFtdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGxldCBuZXdEZWZpbmVzID0ge307XHJcbiAgICAgICAgICAgICAgICBwcm9ncmFtLmRlZmluZXMubWFwKGRlZiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3RGVmaW5lc1tkZWYubmFtZV0gPSBnZXRJbnNwZWN0b3JQcm9wcyhkZWYpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHBhc3MubmFtZSB8fCBwYXNzSWR4LFxyXG4gICAgICAgICAgICAgICAgICAgIHByb3BzOiBuZXdQcm9wcyxcclxuICAgICAgICAgICAgICAgICAgICBkZWZpbmVzOiBuZXdEZWZpbmVzLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBuYW1lOiB0ZWNoLm5hbWUgfHwgdGVjaElkeCxcclxuICAgICAgICAgICAgICAgIHBhc3NlczogcGFzc2VzLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pXHJcbiAgICB9O1xyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiLyJ9