
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/3d/skeleton/CCSkeletonAnimationClip.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

var _mat = _interopRequireDefault(require("../../value-types/mat4"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/****************************************************************************
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 http://www.cocos.com

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var AnimationClip = require('../../../animation/animation-clip');

var JointMatrixCurve = require('./CCJointMatrixCurve');

function maxtrixToArray(matrix) {
  var data = new Float32Array(16);
  data.set(matrix.m);
  return data;
}
/**
* @module cc
*/

/**
 * !#en SkeletonAnimationClip Asset.
 * !#zh 骨骼动画剪辑。
 * @class SkeletonAnimationClip
 * @extends AnimationClip
 */


var SkeletonAnimationClip = cc.Class({
  name: 'cc.SkeletonAnimationClip',
  "extends": AnimationClip,
  properties: {
    _nativeAsset: {
      override: true,
      get: function get() {
        return this._buffer;
      },
      set: function set(bin) {
        var buffer = ArrayBuffer.isView(bin) ? bin.buffer : bin;
        this._buffer = new Float32Array(buffer || bin, 0, buffer.byteLength / 4);
      }
    },

    /**
     * Describe the data structure.
     * { path: { offset, frameCount, property } }
     */
    description: {
      "default": null,
      type: Object
    },

    /**
     * SkeletonAnimationClip's curveData is generated from binary buffer.
     * So should not serialize curveData.
     */
    curveData: {
      visible: false,
      override: true,
      get: function get() {
        return this._curveData || {};
      },
      set: function set() {}
    }
  },
  statics: {
    preventDeferredLoadDependents: true
  },
  _init: function _init() {
    if (this._curveData) {
      return this._curveData;
    }

    this._curveData = {};

    this._generateCommonCurve();

    if (this._model.precomputeJointMatrix) {
      this._generateJointMatrixCurve();
    }

    return this._curveData;
  },
  _generateCommonCurve: function _generateCommonCurve() {
    var buffer = this._buffer;
    var description = this.description;
    var offset = 0;

    function getValue() {
      return buffer[offset++];
    }

    if (!this._curveData.paths) {
      this._curveData.paths = {};
    }

    var paths = this._curveData.paths;

    for (var path in description) {
      var des = description[path];
      var curves = {};
      paths[path] = {
        props: curves
      };

      for (var property in des) {
        var frames = [];
        var frameCount = des[property].frameCount;
        offset = des[property].offset;

        for (var i = 0; i < frameCount; i++) {
          var frame = getValue();
          var value = void 0;

          if (property === 'position' || property === 'scale') {
            value = cc.v3(getValue(), getValue(), getValue());
          } else if (property === 'quat') {
            value = cc.quat(getValue(), getValue(), getValue(), getValue());
          }

          frames.push({
            frame: frame,
            value: value
          });
        }

        curves[property] = frames;
      }
    }
  },
  _generateJointMatrixCurve: function _generateJointMatrixCurve() {
    var rootNode = this._model.rootNode;
    var curveData = this._curveData;
    var paths = curveData.paths;
    var newCurveData = {
      ratios: [],
      jointMatrixMap: {}
    };
    var jointMatrixMap = newCurveData.jointMatrixMap; // walk through node tree to calculate node's joint matrix at time.

    function walk(node, time, pm) {
      var matrix;
      var EPSILON = 10e-5;
      var path = paths[node.path];

      if (node !== rootNode && path) {
        var props = path.props;

        for (var prop in props) {
          var frames = props[prop];

          for (var i = 0; i < frames.length; i++) {
            var end = frames[i];

            if (Math.abs(end.frame - time) < EPSILON) {
              node[prop].set(end.value);
              break;
            } else if (end.frame > time) {
              var start = frames[i - 1];
              var ratio = (time - start.frame) / (end.frame - start.frame);
              start.value.lerp(end.value, ratio, node[prop]);
              break;
            }
          }
        }

        matrix = cc.mat4();

        _mat["default"].fromRTS(matrix, node.quat, node.position, node.scale);

        if (pm) {
          _mat["default"].mul(matrix, pm, matrix);
        }

        if (!props._jointMatrix) {
          props._jointMatrix = [];
        }

        var bindWorldMatrix;

        if (node.uniqueBindPose) {
          bindWorldMatrix = cc.mat4();

          _mat["default"].mul(bindWorldMatrix, matrix, node.uniqueBindPose);
        }

        if (!jointMatrixMap[node.path]) {
          jointMatrixMap[node.path] = [];
        }

        if (bindWorldMatrix) {
          jointMatrixMap[node.path].push(maxtrixToArray(bindWorldMatrix));
        } else {
          jointMatrixMap[node.path].push(matrix);
        }
      }

      var children = node.children;

      for (var name in children) {
        var child = children[name];
        walk(child, time, matrix);
      }
    }

    var time = 0;
    var duration = this.duration;
    var step = 1 / this.sample;

    while (time < duration) {
      newCurveData.ratios.push(time / duration);
      walk(rootNode, time);
      time += step;
    }

    this._curveData = newCurveData;
  },
  _createJointMatrixCurve: function _createJointMatrixCurve(state, root) {
    var curve = new JointMatrixCurve();
    curve.ratios = this.curveData.ratios;
    curve.pairs = [];
    var jointMatrixMap = this.curveData.jointMatrixMap;

    for (var path in jointMatrixMap) {
      var target = cc.find(path, root);
      if (!target) continue;
      curve.pairs.push({
        target: target,
        values: jointMatrixMap[path]
      });
    }

    return [curve];
  },
  createCurves: function createCurves(state, root) {
    if (!this._model) {
      cc.warn("Skeleton Animation Clip [" + this.name + "] Can not find model");
      return [];
    }

    this._init();

    if (this._model.precomputeJointMatrix) {
      return this._createJointMatrixCurve(state, root);
    } else {
      return AnimationClip.prototype.createCurves.call(this, state, root);
    }
  }
});
cc.SkeletonAnimationClip = module.exports = SkeletonAnimationClip;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXZcXGNvY29zMmRcXGNvcmVcXDNkXFxza2VsZXRvblxcQ0NTa2VsZXRvbkFuaW1hdGlvbkNsaXAuanMiXSwibmFtZXMiOlsiQW5pbWF0aW9uQ2xpcCIsInJlcXVpcmUiLCJKb2ludE1hdHJpeEN1cnZlIiwibWF4dHJpeFRvQXJyYXkiLCJtYXRyaXgiLCJkYXRhIiwiRmxvYXQzMkFycmF5Iiwic2V0IiwibSIsIlNrZWxldG9uQW5pbWF0aW9uQ2xpcCIsImNjIiwiQ2xhc3MiLCJuYW1lIiwicHJvcGVydGllcyIsIl9uYXRpdmVBc3NldCIsIm92ZXJyaWRlIiwiZ2V0IiwiX2J1ZmZlciIsImJpbiIsImJ1ZmZlciIsIkFycmF5QnVmZmVyIiwiaXNWaWV3IiwiYnl0ZUxlbmd0aCIsImRlc2NyaXB0aW9uIiwidHlwZSIsIk9iamVjdCIsImN1cnZlRGF0YSIsInZpc2libGUiLCJfY3VydmVEYXRhIiwic3RhdGljcyIsInByZXZlbnREZWZlcnJlZExvYWREZXBlbmRlbnRzIiwiX2luaXQiLCJfZ2VuZXJhdGVDb21tb25DdXJ2ZSIsIl9tb2RlbCIsInByZWNvbXB1dGVKb2ludE1hdHJpeCIsIl9nZW5lcmF0ZUpvaW50TWF0cml4Q3VydmUiLCJvZmZzZXQiLCJnZXRWYWx1ZSIsInBhdGhzIiwicGF0aCIsImRlcyIsImN1cnZlcyIsInByb3BzIiwicHJvcGVydHkiLCJmcmFtZXMiLCJmcmFtZUNvdW50IiwiaSIsImZyYW1lIiwidmFsdWUiLCJ2MyIsInF1YXQiLCJwdXNoIiwicm9vdE5vZGUiLCJuZXdDdXJ2ZURhdGEiLCJyYXRpb3MiLCJqb2ludE1hdHJpeE1hcCIsIndhbGsiLCJub2RlIiwidGltZSIsInBtIiwiRVBTSUxPTiIsInByb3AiLCJsZW5ndGgiLCJlbmQiLCJNYXRoIiwiYWJzIiwic3RhcnQiLCJyYXRpbyIsImxlcnAiLCJtYXQ0IiwiTWF0NCIsImZyb21SVFMiLCJwb3NpdGlvbiIsInNjYWxlIiwibXVsIiwiX2pvaW50TWF0cml4IiwiYmluZFdvcmxkTWF0cml4IiwidW5pcXVlQmluZFBvc2UiLCJjaGlsZHJlbiIsImNoaWxkIiwiZHVyYXRpb24iLCJzdGVwIiwic2FtcGxlIiwiX2NyZWF0ZUpvaW50TWF0cml4Q3VydmUiLCJzdGF0ZSIsInJvb3QiLCJjdXJ2ZSIsInBhaXJzIiwidGFyZ2V0IiwiZmluZCIsInZhbHVlcyIsImNyZWF0ZUN1cnZlcyIsIndhcm4iLCJwcm90b3R5cGUiLCJjYWxsIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQXlCQTs7OztBQXpCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFJQSxJQUFNQSxhQUFhLEdBQUdDLE9BQU8sQ0FBQyxtQ0FBRCxDQUE3Qjs7QUFDQSxJQUFNQyxnQkFBZ0IsR0FBR0QsT0FBTyxDQUFDLHNCQUFELENBQWhDOztBQUVBLFNBQVNFLGNBQVQsQ0FBeUJDLE1BQXpCLEVBQWlDO0FBQzdCLE1BQUlDLElBQUksR0FBRyxJQUFJQyxZQUFKLENBQWlCLEVBQWpCLENBQVg7QUFDQUQsRUFBQUEsSUFBSSxDQUFDRSxHQUFMLENBQVNILE1BQU0sQ0FBQ0ksQ0FBaEI7QUFDQSxTQUFPSCxJQUFQO0FBQ0g7QUFFRDtBQUNBO0FBQ0E7O0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQSxJQUFJSSxxQkFBcUIsR0FBR0MsRUFBRSxDQUFDQyxLQUFILENBQVM7QUFDakNDLEVBQUFBLElBQUksRUFBRSwwQkFEMkI7QUFFakMsYUFBU1osYUFGd0I7QUFJakNhLEVBQUFBLFVBQVUsRUFBRTtBQUNSQyxJQUFBQSxZQUFZLEVBQUU7QUFDVkMsTUFBQUEsUUFBUSxFQUFFLElBREE7QUFFVkMsTUFBQUEsR0FGVSxpQkFFSDtBQUNILGVBQU8sS0FBS0MsT0FBWjtBQUNILE9BSlM7QUFLVlYsTUFB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QUFDdkIsUUFBSSxDQUFDLEtBQUtwRCxNQUFWLEVBQWtCO0FBQ2R2QixNQUFBQSxFQUFFLENBQUNrRixJQUFILCtCQUFvQyxLQUFLaEYsSUFBekM7QUFDQSxhQUFPLEVBQVA7QUFDSDs7QUFFRCxTQUFLbUIsS0FBTDs7QUFFQSxRQUFJLEtBQUtFLE1BQUwsQ0FBWUMscUJBQWhCLEVBQXVDO0FBQ25DLGFBQU8sS0FBS2lELHVCQUFMLENBQTZCQyxLQUE3QixFQUFvQ0MsSUFBcEMsQ0FBUDtBQUNILEtBRkQsTUFHSztBQUNELGFBQU9yRixhQUFhLENBQUM2RixTQUFkLENBQXdCRixZQUF4QixDQUFxQ0csSUFBckMsQ0FBMEMsSUFBMUMsRUFBZ0RWLEtBQWhELEVBQXVEQyxJQUF2RCxDQUFQO0FBQ0g7QUFDSjtBQXpOZ0MsQ0FBVCxDQUE1QjtBQTROQTNFLEVBQUUsQ0FBQ0QscUJBQUgsR0FBMkJzRixNQUFNLENBQUNDLE9BQVAsR0FBaUJ2RixxQkFBNUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxyXG4gQ29weXJpZ2h0IChjKSAyMDE3LTIwMTggWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXHJcblxyXG4gaHR0cDovL3d3dy5jb2Nvcy5jb21cclxuXHJcbiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XHJcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcclxuICB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXHJcbiB0byB1c2UgQ29jb3MgQ3JlYXRvciBzb2xlbHkgdG8gZGV2ZWxvcCBnYW1lcyBvbiB5b3VyIHRhcmdldCBwbGF0Zm9ybXMuIFlvdSBzaGFsbFxyXG4gIG5vdCB1c2UgQ29jb3MgQ3JlYXRvciBzb2Z0d2FyZSBmb3IgZGV2ZWxvcGluZyBvdGhlciBzb2Z0d2FyZSBvciB0b29scyB0aGF0J3NcclxuICB1c2VkIGZvciBkZXZlbG9waW5nIGdhbWVzLiBZb3UgYXJlIG5vdCBncmFudGVkIHRvIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsXHJcbiAgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIENvY29zIENyZWF0b3IuXHJcblxyXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cclxuIFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLiByZXNlcnZlcyBhbGwgcmlnaHRzIG5vdCBleHByZXNzbHkgZ3JhbnRlZCB0byB5b3UuXHJcblxyXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxyXG4gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXHJcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcclxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcclxuIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXHJcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXHJcbiBUSEUgU09GVFdBUkUuXHJcbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xyXG5cclxuaW1wb3J0IE1hdDQgZnJvbSAnLi4vLi4vdmFsdWUtdHlwZXMvbWF0NCc7XHJcblxyXG5jb25zdCBBbmltYXRpb25DbGlwID0gcmVxdWlyZSgnLi4vLi4vLi4vYW5pbWF0aW9uL2FuaW1hdGlvbi1jbGlwJyk7XHJcbmNvbnN0IEpvaW50TWF0cml4Q3VydmUgPSByZXF1aXJlKCcuL0NDSm9pbnRNYXRyaXhDdXJ2ZScpO1xyXG5cclxuZnVuY3Rpb24gbWF4dHJpeFRvQXJyYXkgKG1hdHJpeCkge1xyXG4gICAgbGV0IGRhdGEgPSBuZXcgRmxvYXQzMkFycmF5KDE2KTtcclxuICAgIGRhdGEuc2V0KG1hdHJpeC5tKTtcclxuICAgIHJldHVybiBkYXRhO1xyXG59XHJcblxyXG4vKipcclxuKiBAbW9kdWxlIGNjXHJcbiovXHJcbi8qKlxyXG4gKiAhI2VuIFNrZWxldG9uQW5pbWF0aW9uQ2xpcCBBc3NldC5cclxuICogISN6aCDpqqjpqrzliqjnlLvliarovpHjgIJcclxuICogQGNsYXNzIFNrZWxldG9uQW5pbWF0aW9uQ2xpcFxyXG4gKiBAZXh0ZW5kcyBBbmltYXRpb25DbGlwXHJcbiAqL1xyXG5sZXQgU2tlbGV0b25BbmltYXRpb25DbGlwID0gY2MuQ2xhc3Moe1xyXG4gICAgbmFtZTogJ2NjLlNrZWxldG9uQW5pbWF0aW9uQ2xpcCcsXHJcbiAgICBleHRlbmRzOiBBbmltYXRpb25DbGlwLFxyXG5cclxuICAgIHByb3BlcnRpZXM6IHtcclxuICAgICAgICBfbmF0aXZlQXNzZXQ6IHtcclxuICAgICAgICAgICAgb3ZlcnJpZGU6IHRydWUsXHJcbiAgICAgICAgICAgIGdldCAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fYnVmZmVyO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzZXQgKGJpbikge1xyXG4gICAgICAgICAgICAgICAgbGV0IGJ1ZmZlciA9IEFycmF5QnVmZmVyLmlzVmlldyhiaW4pID8gYmluLmJ1ZmZlciA6IGJpbjtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2J1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyIHx8IGJpbiwgMCwgYnVmZmVyLmJ5dGVMZW5ndGggLyA0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIERlc2NyaWJlIHRoZSBkYXRhIHN0cnVjdHVyZS5cclxuICAgICAgICAgKiB7IHBhdGg6IHsgb2Zmc2V0LCBmcmFtZUNvdW50LCBwcm9wZXJ0eSB9IH1cclxuICAgICAgICAgKi9cclxuICAgICAgICBkZXNjcmlwdGlvbjoge1xyXG4gICAgICAgICAgICBkZWZhdWx0OiBudWxsLFxyXG4gICAgICAgICAgICB0eXBlOiBPYmplY3QsXHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogU2tlbGV0b25BbmltYXRpb25DbGlwJ3MgY3VydmVEYXRhIGlzIGdlbmVyYXRlZCBmcm9tIGJpbmFyeSBidWZmZXIuXHJcbiAgICAgICAgICogU28gc2hvdWxkIG5vdCBzZXJpYWxpemUgY3VydmVEYXRhLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGN1cnZlRGF0YToge1xyXG4gICAgICAgICAgICB2aXNpYmxlOiBmYWxzZSxcclxuICAgICAgICAgICAgb3ZlcnJpZGU6IHRydWUsXHJcbiAgICAgICAgICAgIGdldCAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fY3VydmVEYXRhIHx8IHt9O1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzZXQgKCkge31cclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIHN0YXRpY3M6IHtcclxuICAgICAgICBwcmV2ZW50RGVmZXJyZWRMb2FkRGVwZW5kZW50czogdHJ1ZSxcclxuICAgIH0sXHJcblxyXG4gICAgX2luaXQgKCkge1xyXG4gICAgICAgIGlmICh0aGlzLl9jdXJ2ZURhdGEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2N1cnZlRGF0YTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2N1cnZlRGF0YSA9IHt9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIHRoaXMuX2dlbmVyYXRlQ29tbW9uQ3VydmUoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX21vZGVsLnByZWNvbXB1dGVKb2ludE1hdHJpeCkge1xyXG4gICAgICAgICAgICB0aGlzLl9nZW5lcmF0ZUpvaW50TWF0cml4Q3VydmUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLl9jdXJ2ZURhdGE7XHJcbiAgICB9LFxyXG5cclxuICAgIF9nZW5lcmF0ZUNvbW1vbkN1cnZlICgpIHtcclxuICAgICAgICBsZXQgYnVmZmVyID0gdGhpcy5fYnVmZmVyO1xyXG4gICAgICAgIGxldCBkZXNjcmlwdGlvbiA9IHRoaXMuZGVzY3JpcHRpb247XHJcblxyXG4gICAgICAgIGxldCBvZmZzZXQgPSAwO1xyXG4gICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGJ1ZmZlcltvZmZzZXQrK107XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXRoaXMuX2N1cnZlRGF0YS5wYXRocykge1xyXG4gICAgICAgICAgICB0aGlzLl9jdXJ2ZURhdGEucGF0aHMgPSB7fTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHBhdGhzID0gdGhpcy5fY3VydmVEYXRhLnBhdGhzO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBwYXRoIGluIGRlc2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgIGxldCBkZXMgPSBkZXNjcmlwdGlvbltwYXRoXTtcclxuICAgICAgICAgICAgbGV0IGN1cnZlcyA9IHt9O1xyXG4gICAgICAgICAgICBwYXRoc1twYXRoXSA9IHsgcHJvcHM6IGN1cnZlcyB9O1xyXG5cclxuICAgICAgICAgICAgZm9yIChsZXQgcHJvcGVydHkgaW4gZGVzKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZnJhbWVzID0gW107XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGZyYW1lQ291bnQgPSBkZXNbcHJvcGVydHldLmZyYW1lQ291bnQ7XHJcbiAgICAgICAgICAgICAgICBvZmZzZXQgPSBkZXNbcHJvcGVydHldLm9mZnNldDtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVDb3VudDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZyYW1lID0gZ2V0VmFsdWUoKTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5ID09PSAncG9zaXRpb24nIHx8IHByb3BlcnR5ID09PSAnc2NhbGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gY2MudjMoZ2V0VmFsdWUoKSwgZ2V0VmFsdWUoKSwgZ2V0VmFsdWUoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BlcnR5ID09PSAncXVhdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBjYy5xdWF0KGdldFZhbHVlKCksIGdldFZhbHVlKCksIGdldFZhbHVlKCksIGdldFZhbHVlKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBmcmFtZXMucHVzaCh7IGZyYW1lLCB2YWx1ZSB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjdXJ2ZXNbcHJvcGVydHldID0gZnJhbWVzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBfZ2VuZXJhdGVKb2ludE1hdHJpeEN1cnZlICgpIHtcclxuICAgICAgICBsZXQgcm9vdE5vZGUgPSB0aGlzLl9tb2RlbC5yb290Tm9kZTtcclxuICAgICAgICBsZXQgY3VydmVEYXRhID0gdGhpcy5fY3VydmVEYXRhO1xyXG4gICAgICAgIGxldCBwYXRocyA9IGN1cnZlRGF0YS5wYXRocztcclxuXHJcbiAgICAgICAgbGV0IG5ld0N1cnZlRGF0YSA9IHsgcmF0aW9zOiBbXSwgam9pbnRNYXRyaXhNYXA6IHt9IH07XHJcbiAgICAgICAgbGV0IGpvaW50TWF0cml4TWFwID0gbmV3Q3VydmVEYXRhLmpvaW50TWF0cml4TWFwO1xyXG5cclxuICAgICAgICAvLyB3YWxrIHRocm91Z2ggbm9kZSB0cmVlIHRvIGNhbGN1bGF0ZSBub2RlJ3Mgam9pbnQgbWF0cml4IGF0IHRpbWUuXHJcbiAgICAgICAgZnVuY3Rpb24gd2FsayAobm9kZSwgdGltZSwgcG0pIHtcclxuICAgICAgICAgICAgbGV0IG1hdHJpeDtcclxuICAgICAgICAgICAgbGV0IEVQU0lMT04gPSAxMGUtNTtcclxuXHJcbiAgICAgICAgICAgIGxldCBwYXRoID0gcGF0aHNbbm9kZS5wYXRoXTtcclxuICAgICAgICAgICAgaWYgKG5vZGUgIT09IHJvb3ROb2RlICYmIHBhdGgpIHtcclxuICAgICAgICAgICAgICAgIGxldCBwcm9wcyA9IHBhdGgucHJvcHM7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBwcm9wIGluIHByb3BzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZyYW1lcyA9IHByb3BzW3Byb3BdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlbmQgPSBmcmFtZXNbaV07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZW5kLmZyYW1lIC0gdGltZSkgPCBFUFNJTE9OKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlW3Byb3BdLnNldChlbmQudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZW5kLmZyYW1lID4gdGltZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXJ0ID0gZnJhbWVzW2kgLSAxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCByYXRpbyA9ICh0aW1lIC0gc3RhcnQuZnJhbWUpIC8gKGVuZC5mcmFtZSAtIHN0YXJ0LmZyYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0LnZhbHVlLmxlcnAoZW5kLnZhbHVlLCByYXRpbywgbm9kZVtwcm9wXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBtYXRyaXggPSBjYy5tYXQ0KCk7XHJcbiAgICAgICAgICAgICAgICBNYXQ0LmZyb21SVFMobWF0cml4LCBub2RlLnF1YXQsIG5vZGUucG9zaXRpb24sIG5vZGUuc2NhbGUpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChwbSkge1xyXG4gICAgICAgICAgICAgICAgICAgIE1hdDQubXVsKG1hdHJpeCwgcG0sIG1hdHJpeCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCFwcm9wcy5fam9pbnRNYXRyaXgpIHtcclxuICAgICAgICAgICAgICAgICAgICBwcm9wcy5fam9pbnRNYXRyaXggPSBbXTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgYmluZFdvcmxkTWF0cml4O1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUudW5pcXVlQmluZFBvc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBiaW5kV29ybGRNYXRyaXggPSBjYy5tYXQ0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgTWF0NC5tdWwoYmluZFdvcmxkTWF0cml4LCBtYXRyaXgsIG5vZGUudW5pcXVlQmluZFBvc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICgham9pbnRNYXRyaXhNYXBbbm9kZS5wYXRoXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGpvaW50TWF0cml4TWFwW25vZGUucGF0aF0gPSBbXTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoYmluZFdvcmxkTWF0cml4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgam9pbnRNYXRyaXhNYXBbbm9kZS5wYXRoXS5wdXNoKG1heHRyaXhUb0FycmF5KGJpbmRXb3JsZE1hdHJpeCkpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBqb2ludE1hdHJpeE1hcFtub2RlLnBhdGhdLnB1c2gobWF0cml4KVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgY2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBuYW1lIGluIGNoaWxkcmVuKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY2hpbGQgPSBjaGlsZHJlbltuYW1lXTtcclxuICAgICAgICAgICAgICAgIHdhbGsoY2hpbGQsIHRpbWUsIG1hdHJpeCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB0aW1lID0gMDtcclxuICAgICAgICBsZXQgZHVyYXRpb24gPSB0aGlzLmR1cmF0aW9uO1xyXG4gICAgICAgIGxldCBzdGVwID0gMSAvIHRoaXMuc2FtcGxlO1xyXG5cclxuICAgICAgICB3aGlsZSAodGltZSA8IGR1cmF0aW9uKSB7XHJcbiAgICAgICAgICAgIG5ld0N1cnZlRGF0YS5yYXRpb3MucHVzaCh0aW1lIC8gZHVyYXRpb24pO1xyXG4gICAgICAgICAgICB3YWxrKHJvb3ROb2RlLCB0aW1lKTtcclxuICAgICAgICAgICAgdGltZSArPSBzdGVwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fY3VydmVEYXRhID0gbmV3Q3VydmVEYXRhO1xyXG4gICAgfSxcclxuXHJcbiAgICBfY3JlYXRlSm9pbnRNYXRyaXhDdXJ2ZSAoc3RhdGUsIHJvb3QpIHtcclxuICAgICAgICBsZXQgY3VydmUgPSBuZXcgSm9pbnRNYXRyaXhDdXJ2ZSgpO1xyXG4gICAgICAgIGN1cnZlLnJhdGlvcyA9IHRoaXMuY3VydmVEYXRhLnJhdGlvcztcclxuXHJcbiAgICAgICAgY3VydmUucGFpcnMgPSBbXTtcclxuXHJcbiAgICAgICAgbGV0IGpvaW50TWF0cml4TWFwID0gdGhpcy5jdXJ2ZURhdGEuam9pbnRNYXRyaXhNYXA7XHJcbiAgICAgICAgZm9yIChsZXQgcGF0aCBpbiBqb2ludE1hdHJpeE1hcCkge1xyXG4gICAgICAgICAgICBsZXQgdGFyZ2V0ID0gY2MuZmluZChwYXRoLCByb290KTtcclxuICAgICAgICAgICAgaWYgKCF0YXJnZXQpIGNvbnRpbnVlO1xyXG5cclxuICAgICAgICAgICAgY3VydmUucGFpcnMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICB0YXJnZXQ6IHRhcmdldCxcclxuICAgICAgICAgICAgICAgIHZhbHVlczogam9pbnRNYXRyaXhNYXBbcGF0aF1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gW2N1cnZlXTtcclxuICAgIH0sXHJcblxyXG4gICAgY3JlYXRlQ3VydmVzIChzdGF0ZSwgcm9vdCkge1xyXG4gICAgICAgIGlmICghdGhpcy5fbW9kZWwpIHtcclxuICAgICAgICAgICAgY2Mud2FybihgU2tlbGV0b24gQW5pbWF0aW9uIENsaXAgWyR7dGhpcy5uYW1lfV0gQ2FuIG5vdCBmaW5kIG1vZGVsYCk7XHJcbiAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2luaXQoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX21vZGVsLnByZWNvbXB1dGVKb2ludE1hdHJpeCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fY3JlYXRlSm9pbnRNYXRyaXhDdXJ2ZShzdGF0ZSwgcm9vdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gQW5pbWF0aW9uQ2xpcC5wcm90b3R5cGUuY3JlYXRlQ3VydmVzLmNhbGwodGhpcywgc3RhdGUsIHJvb3QpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XHJcblxyXG5jYy5Ta2VsZXRvbkFuaW1hdGlvbkNsaXAgPSBtb2R1bGUuZXhwb3J0cyA9IFNrZWxldG9uQW5pbWF0aW9uQ2xpcDtcclxuIl0sInNvdXJjZVJvb3QiOiIvIn0=