
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/renderer/canvas/renderers/utils.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
 worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
 not use Cocos Creator software for developing other software or tools that's
 used for developing games. You are not granted to publish, distribute,
 sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var WHITE = (255 << 16) + (255 << 8) + 255;
var MAX_CANVAS_COUNT = 32;

function colorizedFrame(canvas, texture, color, sx, sy, sw, sh) {
  var image = texture._image;
  var ctx = canvas.getContext("2d");
  canvas.width = sw;
  canvas.height = sh; // Draw color

  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = 'rgb(' + color.r + ',' + color.g + ',' + color.b + ')';
  ctx.fillRect(0, 0, sw, sh); // Multiply color with texture

  ctx.globalCompositeOperation = 'multiply';
  ctx.drawImage(image, sx, sy, sw, sh, 0, 0, sw, sh); // Clip out transparent pixels

  ctx.globalCompositeOperation = "destination-atop";
  ctx.drawImage(image, sx, sy, sw, sh, 0, 0, sw, sh);
  return canvas;
}

var canvasMgr = {
  canvasMap: {},
  canvasUsed: {},
  canvasPool: [],
  checking: false,
  check: function check() {
    var exist = false;

    for (var key in this.canvasUsed) {
      exist = true;

      if (!this.canvasUsed[key]) {
        var canvas = this.canvasMap[key];
        canvas.width = 0;
        canvas.height = 0;

        if (this.canvasPool.length < 32) {
          this.canvasPool.push(canvas);
        }

        delete this.canvasMap[key];
        delete this.canvasUsed[key];
      } else {
        this.canvasUsed[key] = false;
      }
    }

    if (!exist) {
      cc.director.off(cc.Director.EVENT_AFTER_DRAW, this.check, this);
      this.checking = false;
    }
  },
  startCheck: function startCheck() {
    cc.director.on(cc.Director.EVENT_AFTER_DRAW, this.check, this);
    this.checking = true;
  },
  getCanvas: function getCanvas(key) {
    this.canvasUsed[key] = true;
    return this.canvasMap[key];
  },
  cacheCanvas: function cacheCanvas(canvas, key) {
    this.canvasMap[key] = canvas;
    this.canvasUsed[key] = true;

    if (!this.checking) {
      this.startCheck();
    }
  },
  dropImage: function dropImage(key) {
    if (this.canvasMap[key]) {
      delete this.canvasMap[key];
    }
  }
};
module.exports = {
  getColorizedImage: function getColorizedImage(texture, color) {
    if (!texture) return null;
    if (texture.width === 0 || texture.height === 0) return texture._image; // original image

    var cval = color._val & 0x00ffffff;

    if (cval === WHITE) {
      return texture._image;
    } // get from cache


    var key = texture.nativeUrl + cval;
    var cache = canvasMgr.getCanvas(key);

    if (!cache) {
      cache = canvasMgr.canvasPool.pop() || document.createElement("canvas");
      colorizedFrame(cache, texture, color, 0, 0, texture.width, texture.height);
      canvasMgr.cacheCanvas(cache, key);
    }

    return cache;
  },
  getFrameCache: function getFrameCache(texture, color, sx, sy, sw, sh) {
    if (!texture || !texture.nativeUrl || sx < 0 || sy < 0 || sw <= 0 || sh <= 0) {
      return null;
    }

    var key = texture.nativeUrl;
    var generate = false;
    var cval = color._val & 0x00ffffff;

    if (cval !== WHITE) {
      key += cval;
      generate = true;
    }

    if (sx !== 0 || sy !== 0 && sw !== texture.width && sh !== texture.height) {
      key += '_' + sx + '_' + sy + '_' + sw + '_' + sh;
      generate = true;
    }

    if (!generate) {
      return texture._image;
    } // get from cache


    var cache = canvasMgr.getCanvas(key);

    if (!cache) {
      cache = canvasMgr.canvasPool.pop() || document.createElement("canvas");
      colorizedFrame(cache, texture, color, sx, sy, sw, sh);
      canvasMgr.cacheCanvas(cache, key);
    }

    return cache;
  },
  dropColorizedImage: function dropColorizedImage(texture, color) {
    var key = texture.nativeUrl + (color._val & 0x00ffffff);
    canvasMgr.dropImage(key);
  }
}; // cache context data of device.

var _globalAlpha = -1;

var context = {
  setGlobalAlpha: function setGlobalAlpha(ctx, alpha) {
    if (_globalAlpha === alpha) {
      return;
    }

    _globalAlpha = alpha;
    ctx.globalAlpha = _globalAlpha;
  },
  reset: function reset() {
    _globalAlpha = -1;
  }
};
module.exports.context = context;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXZcXGNvY29zMmRcXGNvcmVcXHJlbmRlcmVyXFxjYW52YXNcXHJlbmRlcmVyc1xcdXRpbHMuanMiXSwibmFtZXMiOlsiV0hJVEUiLCJNQVhfQ0FOVkFTX0NPVU5UIiwiY29sb3JpemVkRnJhbWUiLCJjYW52YXMiLCJ0ZXh0dXJlIiwiY29sb3IiLCJzeCIsInN5Iiwic3ciLCJzaCIsImltYWdlIiwiX2ltYWdlIiwiY3R4IiwiZ2V0Q29udGV4dCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uIiwiZmlsbFN0eWxlIiwiciIsImciLCJiIiwiZmlsbFJlY3QiLCJkcmF3SW1hZ2UiLCJjYW52YXNNZ3IiLCJjYW52YXNNYXAiLCJjYW52YXNVc2VkIiwiY2FudmFzUG9vbCIsImNoZWNraW5nIiwiY2hlY2siLCJleGlzdCIsImtleSIsImxlbmd0aCIsInB1c2giLCJjYyIsImRpcmVjdG9yIiwib2ZmIiwiRGlyZWN0b3IiLCJFVkVOVF9BRlRFUl9EUkFXIiwic3RhcnRDaGVjayIsIm9uIiwiZ2V0Q2FudmFzIiwiY2FjaGVDYW52YXMiLCJkcm9wSW1hZ2UiLCJtb2R1bGUiLCJleHBvcnRzIiwiZ2V0Q29sb3JpemVkSW1hZ2UiLCJjdmFsIiwiX3ZhbCIsIm5hdGl2ZVVybCIsImNhY2hlIiwicG9wIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwiZ2V0RnJhbWVDYWNoZSIsImdlbmVyYXRlIiwiZHJvcENvbG9yaXplZEltYWdlIiwiX2dsb2JhbEFscGhhIiwiY29udGV4dCIsInNldEdsb2JhbEFscGhhIiwiYWxwaGEiLCJnbG9iYWxBbHBoYSIsInJlc2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FB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aEMsRUFBb0NDLEVBQXBDLENBQWQ7QUFDQWMsTUFBQUEsU0FBUyxDQUFDa0IsV0FBVixDQUFzQlEsS0FBdEIsRUFBNkJuQixHQUE3QjtBQUNIOztBQUNELFdBQU9tQixLQUFQO0FBQ0gsR0FsRFk7QUFvRGJNLEVBQUFBLGtCQXBEYSw4QkFvRE9uRCxPQXBEUCxFQW9EZ0JDLEtBcERoQixFQW9EdUI7QUFDaEMsUUFBSXlCLEdBQUcsR0FBRzFCLE9BQU8sQ0FBQzRDLFNBQVIsSUFBcUIzQyxLQUFLLENBQUMwQyxJQUFOLEdBQWEsVUFBbEMsQ0FBVjtBQUNBeEIsSUFBQUEsU0FBUyxDQUFDbUIsU0FBVixDQUFvQlosR0FBcEI7QUFDSDtBQXZEWSxDQUFqQixFQTBEQTs7QUFDQSxJQUFJMEIsWUFBWSxHQUFHLENBQUMsQ0FBcEI7O0FBRUEsSUFBSUMsT0FBTyxHQUFHO0FBQ1ZDLEVBQUFBLGNBRFUsMEJBQ005QyxHQUROLEVBQ1crQyxLQURYLEVBQ2tCO0FBQ3hCLFFBQUlILFlBQVksS0FBS0csS0FBckIsRUFBNEI7QUFDeEI7QUFDSDs7QUFFREgsSUFBQUEsWUFBWSxHQUFHRyxLQUFmO0FBQ0EvQyxJQUFBQSxHQUFHLENBQUNnRCxXQUFKLEdBQWtCSixZQUFsQjtBQUNILEdBUlM7QUFVVkssRUFBQUEsS0FWVSxtQkFVRDtBQUNMTCxJQUFBQSxZQUFZLEdBQUcsQ0FBQyxDQUFoQjtBQUNIO0FBWlMsQ0FBZDtBQWVBYixNQUFNLENBQUNDLE9BQVAsQ0FBZWEsT0FBZixHQUF5QkEsT0FBekIiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxyXG4gQ29weXJpZ2h0IChjKSAyMDE3LTIwMTggWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXHJcblxyXG4gaHR0cHM6Ly93d3cuY29jb3MuY29tL1xyXG5cclxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcclxuIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZW5naW5lIHNvdXJjZSBjb2RlICh0aGUgXCJTb2Z0d2FyZVwiKSwgYSBsaW1pdGVkLFxyXG4gd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxyXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcclxuIG5vdCB1c2UgQ29jb3MgQ3JlYXRvciBzb2Z0d2FyZSBmb3IgZGV2ZWxvcGluZyBvdGhlciBzb2Z0d2FyZSBvciB0b29scyB0aGF0J3NcclxuIHVzZWQgZm9yIGRldmVsb3BpbmcgZ2FtZXMuIFlvdSBhcmUgbm90IGdyYW50ZWQgdG8gcHVibGlzaCwgZGlzdHJpYnV0ZSxcclxuIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxyXG5cclxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXHJcbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxyXG5cclxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcclxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxyXG4gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXHJcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXHJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxyXG4gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxyXG4gVEhFIFNPRlRXQVJFLlxyXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cclxuXHJcbmNvbnN0IFdISVRFID0gKDI1NTw8MTYpICsgKDI1NTw8OCkgKyAyNTU7XHJcbmNvbnN0IE1BWF9DQU5WQVNfQ09VTlQgPSAzMjtcclxuXHJcbmZ1bmN0aW9uIGNvbG9yaXplZEZyYW1lIChjYW52YXMsIHRleHR1cmUsIGNvbG9yLCBzeCwgc3ksIHN3LCBzaCkge1xyXG4gICAgbGV0IGltYWdlID0gdGV4dHVyZS5faW1hZ2U7XHJcblxyXG4gICAgbGV0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XHJcbiAgICBjYW52YXMud2lkdGggPSBzdztcclxuICAgIGNhbnZhcy5oZWlnaHQgPSBzaDtcclxuXHJcbiAgICAvLyBEcmF3IGNvbG9yXHJcbiAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ3NvdXJjZS1vdmVyJztcclxuICAgIGN0eC5maWxsU3R5bGUgPSAncmdiKCcgKyBjb2xvci5yICsgJywnICsgY29sb3IuZyArICcsJyArIGNvbG9yLmIgKyAnKSc7XHJcbiAgICBjdHguZmlsbFJlY3QoMCwgMCwgc3csIHNoKTtcclxuXHJcbiAgICAvLyBNdWx0aXBseSBjb2xvciB3aXRoIHRleHR1cmVcclxuICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAnbXVsdGlwbHknO1xyXG4gICAgY3R4LmRyYXdJbWFnZShpbWFnZSwgc3gsIHN5LCBzdywgc2gsIDAsIDAsIHN3LCBzaCk7XHJcblxyXG4gICAgLy8gQ2xpcCBvdXQgdHJhbnNwYXJlbnQgcGl4ZWxzXHJcbiAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gXCJkZXN0aW5hdGlvbi1hdG9wXCI7XHJcbiAgICBjdHguZHJhd0ltYWdlKGltYWdlLCBzeCwgc3ksIHN3LCBzaCwgMCwgMCwgc3csIHNoKTtcclxuICAgIHJldHVybiBjYW52YXM7XHJcbn1cclxuXHJcbmxldCBjYW52YXNNZ3IgPSB7XHJcbiAgICBjYW52YXNNYXA6IHt9LFxyXG4gICAgY2FudmFzVXNlZDoge30sXHJcbiAgICBjYW52YXNQb29sOiBbXSxcclxuXHJcbiAgICBjaGVja2luZzogZmFsc2UsXHJcblxyXG4gICAgY2hlY2sgKCkge1xyXG4gICAgICAgIGxldCBleGlzdCA9IGZhbHNlO1xyXG4gICAgICAgIGZvciAobGV0IGtleSBpbiB0aGlzLmNhbnZhc1VzZWQpIHtcclxuICAgICAgICAgICAgZXhpc3QgPSB0cnVlO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY2FudmFzVXNlZFtrZXldKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY2FudmFzID0gdGhpcy5jYW52YXNNYXBba2V5XTtcclxuICAgICAgICAgICAgICAgIGNhbnZhcy53aWR0aCA9IDA7XHJcbiAgICAgICAgICAgICAgICBjYW52YXMuaGVpZ2h0ID0gMDtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbnZhc1Bvb2wubGVuZ3RoIDwgMzIpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbnZhc1Bvb2wucHVzaChjYW52YXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FudmFzTWFwW2tleV07XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jYW52YXNVc2VkW2tleV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhbnZhc1VzZWRba2V5XSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghZXhpc3QpIHtcclxuICAgICAgICAgICAgY2MuZGlyZWN0b3Iub2ZmKGNjLkRpcmVjdG9yLkVWRU5UX0FGVEVSX0RSQVcsIHRoaXMuY2hlY2ssIHRoaXMpO1xyXG4gICAgICAgICAgICB0aGlzLmNoZWNraW5nID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBzdGFydENoZWNrICgpIHtcclxuICAgICAgICBjYy5kaXJlY3Rvci5vbihjYy5EaXJlY3Rvci5FVkVOVF9BRlRFUl9EUkFXLCB0aGlzLmNoZWNrLCB0aGlzKTtcclxuICAgICAgICB0aGlzLmNoZWNraW5nID0gdHJ1ZTtcclxuICAgIH0sXHJcblxyXG4gICAgZ2V0Q2FudmFzIChrZXkpIHtcclxuICAgICAgICB0aGlzLmNhbnZhc1VzZWRba2V5XSA9IHRydWU7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FudmFzTWFwW2tleV07XHJcbiAgICB9LFxyXG5cclxuICAgIGNhY2hlQ2FudmFzIChjYW52YXMsIGtleSkge1xyXG4gICAgICAgIHRoaXMuY2FudmFzTWFwW2tleV0gPSBjYW52YXM7XHJcbiAgICAgICAgdGhpcy5jYW52YXNVc2VkW2tleV0gPSB0cnVlO1xyXG4gICAgICAgIGlmICghdGhpcy5jaGVja2luZykge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXJ0Q2hlY2soKTtcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG4gICAgXHJcbiAgICBkcm9wSW1hZ2UgKGtleSkge1xyXG4gICAgICAgIGlmICh0aGlzLmNhbnZhc01hcFtrZXldKSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbnZhc01hcFtrZXldO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gICAgZ2V0Q29sb3JpemVkSW1hZ2UgKHRleHR1cmUsIGNvbG9yKSB7XHJcbiAgICAgICAgaWYgKCF0ZXh0dXJlKSByZXR1cm4gbnVsbDtcclxuICAgICAgICBpZiAodGV4dHVyZS53aWR0aCA9PT0gMCB8fCB0ZXh0dXJlLmhlaWdodCA9PT0gMCkgIHJldHVybiB0ZXh0dXJlLl9pbWFnZTtcclxuXHJcbiAgICAgICAgLy8gb3JpZ2luYWwgaW1hZ2VcclxuICAgICAgICBsZXQgY3ZhbCA9IGNvbG9yLl92YWwgJiAweDAwZmZmZmZmO1xyXG4gICAgICAgIGlmIChjdmFsID09PSBXSElURSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGV4dHVyZS5faW1hZ2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBnZXQgZnJvbSBjYWNoZVxyXG4gICAgICAgIGxldCBrZXkgPSB0ZXh0dXJlLm5hdGl2ZVVybCArIGN2YWw7XHJcbiAgICAgICAgbGV0IGNhY2hlID0gY2FudmFzTWdyLmdldENhbnZhcyhrZXkpO1xyXG4gICAgICAgIGlmICghY2FjaGUpIHtcclxuICAgICAgICAgICAgY2FjaGUgPSBjYW52YXNNZ3IuY2FudmFzUG9vbC5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xyXG4gICAgICAgICAgICBjb2xvcml6ZWRGcmFtZShjYWNoZSwgdGV4dHVyZSwgY29sb3IsIDAsIDAsIHRleHR1cmUud2lkdGgsIHRleHR1cmUuaGVpZ2h0KTtcclxuICAgICAgICAgICAgY2FudmFzTWdyLmNhY2hlQ2FudmFzKGNhY2hlLCBrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY2FjaGU7XHJcbiAgICB9LFxyXG5cclxuICAgIGdldEZyYW1lQ2FjaGUgKHRleHR1cmUsIGNvbG9yLCBzeCwgc3ksIHN3LCBzaCkge1xyXG4gICAgICAgIGlmICghdGV4dHVyZSB8fCAhdGV4dHVyZS5uYXRpdmVVcmwgfHwgc3ggPCAwIHx8IHN5IDwgMCB8fCBzdyA8PSAwIHx8IHNoIDw9IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQga2V5ID0gdGV4dHVyZS5uYXRpdmVVcmw7XHJcbiAgICAgICAgbGV0IGdlbmVyYXRlID0gZmFsc2U7XHJcbiAgICAgICAgbGV0IGN2YWwgPSBjb2xvci5fdmFsICYgMHgwMGZmZmZmZjtcclxuICAgICAgICBpZiAoY3ZhbCAhPT0gV0hJVEUpIHtcclxuICAgICAgICAgICAga2V5ICs9IGN2YWw7XHJcbiAgICAgICAgICAgIGdlbmVyYXRlID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHN4ICE9PSAwIHx8IHN5ICE9PSAwICYmIHN3ICE9PSB0ZXh0dXJlLndpZHRoICYmIHNoICE9PSB0ZXh0dXJlLmhlaWdodCkge1xyXG4gICAgICAgICAgICBrZXkgKz0gJ18nICsgc3ggKyAnXycgKyBzeSArICdfJyArIHN3ICsgJ18nICsgc2g7XHJcbiAgICAgICAgICAgIGdlbmVyYXRlID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFnZW5lcmF0ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGV4dHVyZS5faW1hZ2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIGdldCBmcm9tIGNhY2hlXHJcbiAgICAgICAgbGV0IGNhY2hlID0gY2FudmFzTWdyLmdldENhbnZhcyhrZXkpO1xyXG4gICAgICAgIGlmICghY2FjaGUpIHtcclxuICAgICAgICAgICAgY2FjaGUgPSBjYW52YXNNZ3IuY2FudmFzUG9vbC5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xyXG4gICAgICAgICAgICBjb2xvcml6ZWRGcmFtZShjYWNoZSwgdGV4dHVyZSwgY29sb3IsIHN4LCBzeSwgc3csIHNoKTtcclxuICAgICAgICAgICAgY2FudmFzTWdyLmNhY2hlQ2FudmFzKGNhY2hlLCBrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY2FjaGU7XHJcbiAgICB9LFxyXG5cclxuICAgIGRyb3BDb2xvcml6ZWRJbWFnZSAodGV4dHVyZSwgY29sb3IpIHtcclxuICAgICAgICBsZXQga2V5ID0gdGV4dHVyZS5uYXRpdmVVcmwgKyAoY29sb3IuX3ZhbCAmIDB4MDBmZmZmZmYpO1xyXG4gICAgICAgIGNhbnZhc01nci5kcm9wSW1hZ2Uoa2V5KTtcclxuICAgIH1cclxufTtcclxuXHJcbi8vIGNhY2hlIGNvbnRleHQgZGF0YSBvZiBkZXZpY2UuXHJcbmxldCBfZ2xvYmFsQWxwaGEgPSAtMTtcclxuXHJcbmxldCBjb250ZXh0ID0ge1xyXG4gICAgc2V0R2xvYmFsQWxwaGEgKGN0eCwgYWxwaGEpIHtcclxuICAgICAgICBpZiAoX2dsb2JhbEFscGhhID09PSBhbHBoYSkge1xyXG4gICAgICAgICAgICByZXR1cm4gXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBfZ2xvYmFsQWxwaGEgPSBhbHBoYTtcclxuICAgICAgICBjdHguZ2xvYmFsQWxwaGEgPSBfZ2xvYmFsQWxwaGE7XHJcbiAgICB9LFxyXG5cclxuICAgIHJlc2V0ICgpIHtcclxuICAgICAgICBfZ2xvYmFsQWxwaGEgPSAtMTtcclxuICAgIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMuY29udGV4dCA9IGNvbnRleHQ7Il0sInNvdXJjZVJvb3QiOiIvIn0=