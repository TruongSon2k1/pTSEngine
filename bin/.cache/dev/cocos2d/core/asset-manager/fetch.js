
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/asset-manager/fetch.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2019 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var packManager = require('./pack-manager');

var Task = require('./task');

var _require = require('./utilities'),
    getDepends = _require.getDepends,
    clear = _require.clear,
    forEach = _require.forEach;

var _require2 = require('./shared'),
    assets = _require2.assets,
    fetchPipeline = _require2.fetchPipeline;

function fetch(task, done) {
  var firstTask = false;

  if (!task.progress) {
    task.progress = {
      finish: 0,
      total: task.input.length,
      canInvoke: true
    };
    firstTask = true;
  }

  var options = task.options,
      depends = [],
      progress = task.progress,
      total = progress.total;
  options.__exclude__ = options.__exclude__ || Object.create(null);
  task.output = [];
  forEach(task.input, function (item, cb) {
    if (!item.isNative && assets.has(item.uuid)) {
      var asset = assets.get(item.uuid);
      asset.addRef();
      handle(item, task, asset, null, asset.__asyncLoadAssets__, depends, total, done);
      return cb();
    }

    packManager.load(item, task.options, function (err, data) {
      if (err) {
        if (!task.isFinish) {
          if (!cc.assetManager.force || firstTask) {
            cc.error(err.message, err.stack);
            progress.canInvoke = false;
            done(err);
          } else {
            handle(item, task, null, null, false, depends, total, done);
          }
        }
      } else {
        if (!task.isFinish) handle(item, task, null, data, !item.isNative, depends, total, done);
      }

      cb();
    });
  }, function () {
    if (task.isFinish) {
      clear(task, true);
      return task.dispatch('error');
    }

    if (depends.length > 0) {
      // stage 2 , download depend asset
      var subTask = Task.create({
        name: task.name + ' dependencies',
        input: depends,
        progress: progress,
        options: options,
        onProgress: task.onProgress,
        onError: Task.prototype.recycle,
        onComplete: function onComplete(err) {
          if (!err) {
            task.output.push.apply(task.output, this.output);
            subTask.recycle();
          }

          if (firstTask) decreaseRef(task);
          done(err);
        }
      });
      fetchPipeline.async(subTask);
      return;
    }

    if (firstTask) decreaseRef(task);
    done();
  });
}

function decreaseRef(task) {
  var output = task.output;

  for (var i = 0, l = output.length; i < l; i++) {
    output[i].content && output[i].content.decRef(false);
  }
}

function handle(item, task, content, file, loadDepends, depends, last, done) {
  var exclude = task.options.__exclude__;
  var progress = task.progress;
  item.content = content;
  item.file = file;
  task.output.push(item);

  if (loadDepends) {
    exclude[item.uuid] = true;
    getDepends(item.uuid, file || content, exclude, depends, true, false, item.config);
    progress.total = last + depends.length;
  }

  progress.canInvoke && task.dispatch('progress', ++progress.finish, progress.total, item);
}

module.exports = fetch;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXZcXGNvY29zMmRcXGNvcmVcXGFzc2V0LW1hbmFnZXJcXGZldGNoLmpzIl0sIm5hbWVzIjpbInBhY2tNYW5hZ2VyIiwicmVxdWlyZSIsIlRhc2siLCJnZXREZXBlbmRzIiwiY2xlYXIiLCJmb3JFYWNoIiwiYXNzZXRzIiwiZmV0Y2hQaXBlbGluZSIsImZldGNoIiwidGFzayIsImRvbmUiLCJmaXJzdFRhc2siLCJwcm9ncmVzcyIsImZpbmlzaCIsInRvdGFsIiwiaW5wdXQiLCJsZW5ndGgiLCJjYW5JbnZva2UiLCJvcHRpb25zIiwiZGVwZW5kcyIsIl9fZXhjbHVkZV9fIiwiT2JqZWN0IiwiY3JlYXRlIiwib3V0cHV0IiwiaXRlbSIsImNiIiwiaXNOYXRpdmUiLCJoYXMiLCJ1dWlkIiwiYXNzZXQiLCJnZXQiLCJhZGRSZWYiLCJoYW5kbGUiLCJfX2FzeW5jTG9hZEFzc2V0c19fIiwibG9hZCIsImVyciIsImRhdGEiLCJpc0ZpbmlzaCIsImNjIiwiYXNzZXRNYW5hZ2VyIiwiZm9yY2UiLCJlcnJvciIsIm1lc3NhZ2UiLCJzdGFjayIsImRpc3BhdGNoIiwic3ViVGFzayIsIm5hbWUiLCJvblByb2dyZXNzIiwib25FcnJvciIsInByb3RvdHlwZSIsInJlY3ljbGUiLCJvbkNvbXBsZXRlIiwicHVzaCIsImFwcGx5IiwiZGVjcmVhc2VSZWYiLCJhc3luYyIsImkiLCJsIiwiY29udGVudCIsImRlY1JlZiIsImZpbGUiLCJsb2FkRGVwZW5kcyIsImxhc3QiLCJleGNsdWRlIiwiY29uZmlnIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLFdBQVcsR0FBR0MsT0FBTyxDQUFDLGdCQUFE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QUFBQSxVQUFVLENBQUNxQixJQUFJLENBQUNJLElBQU4sRUFBWWdDLElBQUksSUFBSUYsT0FBcEIsRUFBNkJLLE9BQTdCLEVBQXNDNUMsT0FBdEMsRUFBK0MsSUFBL0MsRUFBcUQsS0FBckQsRUFBNERLLElBQUksQ0FBQ3dDLE1BQWpFLENBQVY7QUFDQXBELElBQUFBLFFBQVEsQ0FBQ0UsS0FBVCxHQUFpQmdELElBQUksR0FBRzNDLE9BQU8sQ0FBQ0gsTUFBaEM7QUFDSDs7QUFFREosRUFBQUEsUUFBUSxDQUFDSyxTQUFULElBQXNCUixJQUFJLENBQUNtQyxRQUFMLENBQWMsVUFBZCxFQUEwQixFQUFFaEMsUUFBUSxDQUFDQyxNQUFyQyxFQUE2Q0QsUUFBUSxDQUFDRSxLQUF0RCxFQUE2RFUsSUFBN0QsQ0FBdEI7QUFDSDs7QUFFRHlDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjFELEtBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcclxuIENvcHlyaWdodCAoYykgMjAxOSBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cclxuXHJcbiBodHRwczovL3d3dy5jb2Nvcy5jb20vXHJcblxyXG4gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxyXG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXHJcbiAgd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxyXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcclxuICBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXHJcbiAgdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxyXG4gIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxyXG5cclxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXHJcbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxyXG5cclxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcclxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxyXG4gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXHJcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXHJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxyXG4gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxyXG4gVEhFIFNPRlRXQVJFLlxyXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cclxuY29uc3QgcGFja01hbmFnZXIgPSByZXF1aXJlKCcuL3BhY2stbWFuYWdlcicpO1xyXG5jb25zdCBUYXNrID0gcmVxdWlyZSgnLi90YXNrJyk7XHJcbmNvbnN0IHsgZ2V0RGVwZW5kcywgY2xlYXIsIGZvckVhY2ggfSA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzJyk7XHJcbmNvbnN0IHsgYXNzZXRzLCBmZXRjaFBpcGVsaW5lIH0gPSByZXF1aXJlKCcuL3NoYXJlZCcpO1xyXG5cclxuZnVuY3Rpb24gZmV0Y2ggKHRhc2ssIGRvbmUpIHtcclxuXHJcbiAgICBsZXQgZmlyc3RUYXNrID0gZmFsc2U7XHJcbiAgICBpZiAoIXRhc2sucHJvZ3Jlc3MpIHtcclxuICAgICAgICB0YXNrLnByb2dyZXNzID0geyBmaW5pc2g6IDAsIHRvdGFsOiB0YXNrLmlucHV0Lmxlbmd0aCwgY2FuSW52b2tlOiB0cnVlIH07IFxyXG4gICAgICAgIGZpcnN0VGFzayA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IG9wdGlvbnMgPSB0YXNrLm9wdGlvbnMsIGRlcGVuZHMgPSBbXSwgcHJvZ3Jlc3MgPSB0YXNrLnByb2dyZXNzLCB0b3RhbCA9IHByb2dyZXNzLnRvdGFsO1xyXG4gICAgb3B0aW9ucy5fX2V4Y2x1ZGVfXyA9IG9wdGlvbnMuX19leGNsdWRlX18gfHwgT2JqZWN0LmNyZWF0ZShudWxsKTtcclxuXHJcbiAgICB0YXNrLm91dHB1dCA9IFtdO1xyXG5cclxuICAgIGZvckVhY2godGFzay5pbnB1dCwgZnVuY3Rpb24gKGl0ZW0sIGNiKSB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCFpdGVtLmlzTmF0aXZlICYmIGFzc2V0cy5oYXMoaXRlbS51dWlkKSkge1xyXG4gICAgICAgICAgICB2YXIgYXNzZXQgPSBhc3NldHMuZ2V0KGl0ZW0udXVpZCk7XHJcbiAgICAgICAgICAgIGFzc2V0LmFkZFJlZigpO1xyXG4gICAgICAgICAgICBoYW5kbGUoaXRlbSwgdGFzaywgYXNzZXQsIG51bGwsIGFzc2V0Ll9fYXN5bmNMb2FkQXNzZXRzX18sIGRlcGVuZHMsIHRvdGFsLCBkb25lKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNiKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwYWNrTWFuYWdlci5sb2FkKGl0ZW0sIHRhc2sub3B0aW9ucywgZnVuY3Rpb24gKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRhc2suaXNGaW5pc2gpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWNjLmFzc2V0TWFuYWdlci5mb3JjZSB8fCBmaXJzdFRhc2spIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2MuZXJyb3IoZXJyLm1lc3NhZ2UsIGVyci5zdGFjayk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzLmNhbkludm9rZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb25lKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGUoaXRlbSwgdGFzaywgbnVsbCwgbnVsbCwgZmFsc2UsIGRlcGVuZHMsIHRvdGFsLCBkb25lKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRhc2suaXNGaW5pc2gpIGhhbmRsZShpdGVtLCB0YXNrLCBudWxsLCBkYXRhLCAhaXRlbS5pc05hdGl2ZSwgZGVwZW5kcywgdG90YWwsIGRvbmUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNiKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICB9LCBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgIGlmICh0YXNrLmlzRmluaXNoKSB7XHJcbiAgICAgICAgICAgIGNsZWFyKHRhc2ssIHRydWUpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGFzay5kaXNwYXRjaCgnZXJyb3InKTtcclxuICAgICAgICB9IFxyXG4gICAgICAgIGlmIChkZXBlbmRzLmxlbmd0aCA+IDApIHtcclxuXHJcbiAgICAgICAgICAgIC8vIHN0YWdlIDIgLCBkb3dubG9hZCBkZXBlbmQgYXNzZXRcclxuICAgICAgICAgICAgbGV0IHN1YlRhc2sgPSBUYXNrLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgICAgICBuYW1lOiB0YXNrLm5hbWUgKyAnIGRlcGVuZGVuY2llcycsXHJcbiAgICAgICAgICAgICAgICBpbnB1dDogZGVwZW5kcyxcclxuICAgICAgICAgICAgICAgIHByb2dyZXNzLFxyXG4gICAgICAgICAgICAgICAgb3B0aW9ucyxcclxuICAgICAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IHRhc2sub25Qcm9ncmVzcyxcclxuICAgICAgICAgICAgICAgIG9uRXJyb3I6IFRhc2sucHJvdG90eXBlLnJlY3ljbGUsXHJcbiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlOiBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5vdXRwdXQucHVzaC5hcHBseSh0YXNrLm91dHB1dCwgdGhpcy5vdXRwdXQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJUYXNrLnJlY3ljbGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpcnN0VGFzaykgZGVjcmVhc2VSZWYodGFzayk7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9uZShlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGZldGNoUGlwZWxpbmUuYXN5bmMoc3ViVGFzayk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGZpcnN0VGFzaykgZGVjcmVhc2VSZWYodGFzayk7XHJcbiAgICAgICAgZG9uZSgpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRlY3JlYXNlUmVmICh0YXNrKSB7XHJcbiAgICBsZXQgb3V0cHV0ID0gdGFzay5vdXRwdXQ7XHJcbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IG91dHB1dC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICBvdXRwdXRbaV0uY29udGVudCAmJiBvdXRwdXRbaV0uY29udGVudC5kZWNSZWYoZmFsc2UpO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGUgKGl0ZW0sIHRhc2ssIGNvbnRlbnQsIGZpbGUsIGxvYWREZXBlbmRzLCBkZXBlbmRzLCBsYXN0LCBkb25lKSB7XHJcblxyXG4gICAgdmFyIGV4Y2x1ZGUgPSB0YXNrLm9wdGlvbnMuX19leGNsdWRlX187XHJcbiAgICB2YXIgcHJvZ3Jlc3MgPSB0YXNrLnByb2dyZXNzO1xyXG5cclxuICAgIGl0ZW0uY29udGVudCA9IGNvbnRlbnQ7XHJcbiAgICBpdGVtLmZpbGUgPSBmaWxlO1xyXG4gICAgdGFzay5vdXRwdXQucHVzaChpdGVtKTtcclxuXHJcbiAgICBpZiAobG9hZERlcGVuZHMpIHtcclxuICAgICAgICBleGNsdWRlW2l0ZW0udXVpZF0gPSB0cnVlO1xyXG4gICAgICAgIGdldERlcGVuZHMoaXRlbS51dWlkLCBmaWxlIHx8IGNvbnRlbnQsIGV4Y2x1ZGUsIGRlcGVuZHMsIHRydWUsIGZhbHNlLCBpdGVtLmNvbmZpZyk7XHJcbiAgICAgICAgcHJvZ3Jlc3MudG90YWwgPSBsYXN0ICsgZGVwZW5kcy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvZ3Jlc3MuY2FuSW52b2tlICYmIHRhc2suZGlzcGF0Y2goJ3Byb2dyZXNzJywgKytwcm9ncmVzcy5maW5pc2gsIHByb2dyZXNzLnRvdGFsLCBpdGVtKTtcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBmZXRjaDsiXSwic291cmNlUm9vdCI6Ii8ifQ==