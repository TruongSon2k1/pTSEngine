
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/asset-manager/releaseManager.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2019 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var dependUtil = require('./depend-util');

var Cache = require('./cache');

require('../assets/CCAsset');

var _require = require('./shared'),
    assets = _require.assets;

var _require2 = require('../platform/utils'),
    callInNextTick = _require2.callInNextTick;

function visitAsset(asset, deps) {
  // Skip assets generated programmatically or by user (e.g. label texture)
  if (!asset._uuid) {
    return;
  }

  deps.push(asset._uuid);
}

function visitComponent(comp, deps) {
  var props = Object.getOwnPropertyNames(comp);

  for (var i = 0; i < props.length; i++) {
    var propName = props[i];
    if (propName === 'node' || propName === '__eventTargets') continue;
    var value = comp[propName];

    if (typeof value === 'object' && value) {
      if (Array.isArray(value)) {
        for (var j = 0; j < value.length; j++) {
          var val = value[j];

          if (val instanceof cc.Asset) {
            visitAsset(val, deps);
          }
        }
      } else if (!value.constructor || value.constructor === Object) {
        var keys = Object.getOwnPropertyNames(value);

        for (var _j = 0; _j < keys.length; _j++) {
          var _val = value[keys[_j]];

          if (_val instanceof cc.Asset) {
            visitAsset(_val, deps);
          }
        }
      } else if (value instanceof cc.Asset) {
        visitAsset(value, deps);
      }
    }
  }
}

var _temp = [];

function visitNode(node, deps) {
  for (var i = 0; i < node._components.length; i++) {
    visitComponent(node._components[i], deps);
  }

  for (var _i = 0; _i < node._children.length; _i++) {
    visitNode(node._children[_i], deps);
  }
}

function descendOpRef(asset, refs, exclude, op) {
  exclude.push(asset._uuid);
  var depends = dependUtil.getDeps(asset._uuid);

  for (var i = 0, l = depends.length; i < l; i++) {
    var dependAsset = assets.get(depends[i]);

    if (dependAsset) {
      var uuid = dependAsset._uuid;

      if (!(uuid in refs)) {
        refs[uuid] = dependAsset.refCount + op;
      } else {
        refs[uuid] += op;
      }

      if (exclude.includes(uuid)) continue;
      descendOpRef(dependAsset, refs, exclude, op);
    }
  }
}

function checkCircularReference(asset) {
  // check circular reference
  var refs = Object.create(null);
  refs[asset._uuid] = asset.refCount;
  descendOpRef(asset, refs, _temp, -1);
  _temp.length = 0;
  if (refs[asset._uuid] !== 0) return refs[asset._uuid];

  for (var uuid in refs) {
    if (refs[uuid] !== 0) {
      descendOpRef(assets.get(uuid), refs, _temp, 1);
    }
  }

  _temp.length = 0;
  return refs[asset._uuid];
}

var _persistNodeDeps = new Cache();

var _toDelete = new Cache();

var eventListener = false;

function freeAssets() {
  eventListener = false;

  _toDelete.forEach(function (asset) {
    releaseManager._free(asset);
  });

  _toDelete.clear();
}

var releaseManager = {
  init: function init() {
    _persistNodeDeps.clear();

    _toDelete.clear();
  },
  _addPersistNodeRef: function _addPersistNodeRef(node) {
    var deps = [];
    visitNode(node, deps);

    for (var i = 0, l = deps.length; i < l; i++) {
      var dependAsset = assets.get(deps[i]);

      if (dependAsset) {
        dependAsset.addRef();
      }
    }

    _persistNodeDeps.add(node.uuid, deps);
  },
  _removePersistNodeRef: function _removePersistNodeRef(node) {
    if (_persistNodeDeps.has(node.uuid)) {
      var deps = _persistNodeDeps.get(node.uuid);

      for (var i = 0, l = deps.length; i < l; i++) {
        var dependAsset = assets.get(deps[i]);

        if (dependAsset) {
          dependAsset.decRef();
        }
      }

      _persistNodeDeps.remove(node.uuid);
    }
  },
  // do auto release
  _autoRelease: function _autoRelease(oldScene, newScene, persistNodes) {
    if (oldScene) {
      var childs = dependUtil.getDeps(oldScene._id);

      for (var i = 0, l = childs.length; i < l; i++) {
        var asset = assets.get(childs[i]);
        asset && asset.decRef(CC_TEST || oldScene.autoReleaseAssets);
      }

      var dependencies = dependUtil._depends.get(oldScene._id);

      if (dependencies && dependencies.persistDeps) {
        var persistDeps = dependencies.persistDeps;

        for (var _i2 = 0, _l = persistDeps.length; _i2 < _l; _i2++) {
          var _asset = assets.get(persistDeps[_i2]);

          _asset && _asset.decRef(CC_TEST || oldScene.autoReleaseAssets);
        }
      }

      oldScene._id !== newScene._id && dependUtil.remove(oldScene._id);
    }

    var sceneDeps = dependUtil._depends.get(newScene._id);

    sceneDeps && (sceneDeps.persistDeps = []); // transfer refs from persist nodes to new scene

    for (var key in persistNodes) {
      var node = persistNodes[key];

      var deps = _persistNodeDeps.get(node.uuid);

      for (var _i3 = 0, _l2 = deps.length; _i3 < _l2; _i3++) {
        var dependAsset = assets.get(deps[_i3]);

        if (dependAsset) {
          dependAsset.addRef();
        }
      }

      if (sceneDeps) {
        sceneDeps.persistDeps.push.apply(sceneDeps.persistDeps, deps);
      }
    }
  },
  _free: function _free(asset, force) {
    _toDelete.remove(asset._uuid);

    if (!cc.isValid(asset, true)) return;

    if (!force) {
      if (asset.refCount > 0) {
        if (checkCircularReference(asset) > 0) return;
      }
    } // remove from cache


    assets.remove(asset._uuid);
    var depends = dependUtil.getDeps(asset._uuid);

    for (var i = 0, l = depends.length; i < l; i++) {
      var dependAsset = assets.get(depends[i]);

      if (dependAsset) {
        dependAsset.decRef(false);

        releaseManager._free(dependAsset, false);
      }
    }

    asset.destroy();
    dependUtil.remove(asset._uuid);
  },
  tryRelease: function tryRelease(asset, force) {
    if (!(asset instanceof cc.Asset)) return;

    if (force) {
      releaseManager._free(asset, force);
    } else {
      _toDelete.add(asset._uuid, asset);

      if (!eventListener) {
        eventListener = true;
        callInNextTick(freeAssets);
      }
    }
  }
};
module.exports = releaseManager;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXZcXGNvY29zMmRcXGNvcmVcXGFzc2V0LW1hbmFnZXJcXHJlbGVhc2VNYW5hZ2VyLmpzIl0sIm5hbWVzIjpbImRlcGVuZFV0aWwiLCJyZXF1aXJlIiwiQ2FjaGUiLCJhc3NldHMiLCJjYWxsSW5OZXh0VGljayIsInZpc2l0QXNzZXQiLCJhc3NldCIsImRlcHMiLCJfdXVpZCIsInB1c2giLCJ2aXNpdENvbXBvbmVudCIsImNvbXAiLCJwcm9wcyIsIk9iamVjdCIsImdldE93blByb3BlcnR5TmFtZXMiLCJpIiwibGVuZ3RoIiwicHJvcE5hbWUiLCJ2YWx1ZSIsIkFycmF5IiwiaXNBcnJheSIsImoiLCJ2YWwiLCJjYyIsIkFzc2V0IiwiY29uc3RydWN0b3IiLCJrZXlzIiwiX3RlbXAiLCJ2aXNpdE5vZGUiLCJub2RlIiwiX2NvbXBvbmVudHMiLCJfY2hpbGRyZW4iLCJkZXNjZW5kT3BSZWYiLCJyZWZzIiwiZXhjbHVkZSIsIm9wIiwiZGVwZW5kcyIsImdldERlcHMiLCJsIiwiZGVwZW5kQXNzZXQiLCJnZXQiLCJ1dWlkIiwicmVmQ291bnQiLCJpbmNsdWRlcyIsImNoZWNrQ2lyY3VsYXJSZWZlcmVuY2UiLCJjcmVhdGUiLCJfcGVyc2lzdE5vZGVEZXBzIiwiX3RvRGVsZXRlIiwiZXZlbnRMaXN0ZW5lciIsImZyZWVBc3NldHMiLCJmb3JFYWNoIiwicmVsZWFzZU1hbmFnZXIiLCJfZnJlZSIsImNsZWFyIiwiaW5pdCIsIl9hZGRQZXJzaXN0Tm9kZVJlZiIsImFkZFJlZiIsImFkZCIsIl9yZW1vdmVQZXJzaXN0Tm9kZVJlZiIsImhhcyIsImRlY1JlZiIsInJlbW92ZSIsIl9hdXRvUmVsZWFzZSIsIm9sZFNjZW5lIiwibmV3U2NlbmUiLCJwZXJzaXN0Tm9kZXMiLCJjaGlsZHMiLCJfaWQiLCJDQ19URVNUIiwiYXV0b1JlbGVhc2VBc3NldHMiLCJkZXBlbmRlbmNpZXMiLCJfZGVwZW5kcyIsInBlcnNpc3REZXBzIiwic2NlbmVEZXBzIiwia2V5IiwiYXBwbHkiLCJmb3JjZSIsImlzVmFsaWQiLCJkZXN0cm95IiwidHJ5UmVsZWFzZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSxVQUFVLEdBQUdDLE9BQU8sQ0FBQyxlQUFELENBQTFCOztBQUNBLElBQU1DLEtBQUssR0FBR0QsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBQ0FBLE9BQU8sQ0FBQyxtQkFBRCxDQUFQOztlQUNtQkEsT0FBTyxDQUFDLFVBQUQ7SUFBbEJFLGtCQUFBQTs7Z0JBQ21CRixPQUFPLENBQUMsbUJBQUQ7SUFBMUJHLDJCQUFBQTs7QUFFUixTQUFTQyxVQUFULENBQXFCQyxLQUFyQixFQUE0QkMsSUFBNUIsRUFBa0M7QUFDOUI7QUFDQSxNQUFJLENBQUNELEtBQUssQ0FBQ0UsS0FBWCxFQUFrQjtBQUNkO0FBQ0g7O0FBQ0RELEVBQUFBLElBQUksQ0FBQ0UsSUFBTCxDQUFVSCxLQUFLLENBQUNFLEtBQWhCO0FBQ0g7O0FBRUQsU0FBU0UsY0FBVCxDQUF5QkMsSUFBekIsRUFBK0JKLElBQS9CLEVBQXFDO0FBQ2pDLE1BQUlLLEtBQUssR0FBR0MsTUFBTSxDQUFDQyxtQkFBUCxDQUEyQkgsSUFBM0IsQ0FBWjs7QUFDQSxPQUFLLElBQUlJLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdILEtBQUssQ0FBQ0ksTUFBMUIsRUFBa0NELENBQUMsRUFBbkMsRUFBdUM7QUFDbkMsUUFBSUUsUUFBUSxHQUFHTCxLQUFLLENBQUNHLENBQUQsQ0FBcEI7QUFDQSxRQUFJRSxRQUFRLEtBQUssTUFBYixJQUF1QkEsUUFBUSxLQUFLLGdCQUF4QyxFQUEwRDtBQUMxRCxRQUFJQyxLQUFLLEdBQUdQLElBQUksQ0FBQ00sUUFB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QUFQLEdBQWlCOUIsY0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxyXG4gQ29weXJpZ2h0IChjKSAyMDE5IFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLlxyXG5cclxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cclxuXHJcbiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XHJcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcclxuICB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXHJcbiB0byB1c2UgQ29jb3MgQ3JlYXRvciBzb2xlbHkgdG8gZGV2ZWxvcCBnYW1lcyBvbiB5b3VyIHRhcmdldCBwbGF0Zm9ybXMuIFlvdSBzaGFsbFxyXG4gIG5vdCB1c2UgQ29jb3MgQ3JlYXRvciBzb2Z0d2FyZSBmb3IgZGV2ZWxvcGluZyBvdGhlciBzb2Z0d2FyZSBvciB0b29scyB0aGF0J3NcclxuICB1c2VkIGZvciBkZXZlbG9waW5nIGdhbWVzLiBZb3UgYXJlIG5vdCBncmFudGVkIHRvIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsXHJcbiAgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIENvY29zIENyZWF0b3IuXHJcblxyXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cclxuIFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLiByZXNlcnZlcyBhbGwgcmlnaHRzIG5vdCBleHByZXNzbHkgZ3JhbnRlZCB0byB5b3UuXHJcblxyXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxyXG4gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXHJcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcclxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcclxuIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXHJcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXHJcbiBUSEUgU09GVFdBUkUuXHJcbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xyXG5jb25zdCBkZXBlbmRVdGlsID0gcmVxdWlyZSgnLi9kZXBlbmQtdXRpbCcpO1xyXG5jb25zdCBDYWNoZSA9IHJlcXVpcmUoJy4vY2FjaGUnKTtcclxucmVxdWlyZSgnLi4vYXNzZXRzL0NDQXNzZXQnKTtcclxuY29uc3QgeyBhc3NldHMgfSA9IHJlcXVpcmUoJy4vc2hhcmVkJyk7XHJcbmNvbnN0IHsgY2FsbEluTmV4dFRpY2sgfSA9IHJlcXVpcmUoJy4uL3BsYXRmb3JtL3V0aWxzJyk7XHJcblxyXG5mdW5jdGlvbiB2aXNpdEFzc2V0IChhc3NldCwgZGVwcykge1xyXG4gICAgLy8gU2tpcCBhc3NldHMgZ2VuZXJhdGVkIHByb2dyYW1tYXRpY2FsbHkgb3IgYnkgdXNlciAoZS5nLiBsYWJlbCB0ZXh0dXJlKVxyXG4gICAgaWYgKCFhc3NldC5fdXVpZCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGRlcHMucHVzaChhc3NldC5fdXVpZCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHZpc2l0Q29tcG9uZW50IChjb21wLCBkZXBzKSB7XHJcbiAgICB2YXIgcHJvcHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhjb21wKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICB2YXIgcHJvcE5hbWUgPSBwcm9wc1tpXTtcclxuICAgICAgICBpZiAocHJvcE5hbWUgPT09ICdub2RlJyB8fCBwcm9wTmFtZSA9PT0gJ19fZXZlbnRUYXJnZXRzJykgY29udGludWU7XHJcbiAgICAgICAgdmFyIHZhbHVlID0gY29tcFtwcm9wTmFtZV07XHJcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHZhbHVlLmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHZhbCA9IHZhbHVlW2pdO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWwgaW5zdGFuY2VvZiBjYy5Bc3NldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2aXNpdEFzc2V0KHZhbCwgZGVwcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCF2YWx1ZS5jb25zdHJ1Y3RvciB8fCB2YWx1ZS5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBsZXQga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwga2V5cy5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB2YWwgPSB2YWx1ZVtrZXlzW2pdXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsIGluc3RhbmNlb2YgY2MuQXNzZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmlzaXRBc3NldCh2YWwsIGRlcHMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGNjLkFzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICB2aXNpdEFzc2V0KHZhbHVlLCBkZXBzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxubGV0IF90ZW1wID0gW107XHJcblxyXG5mdW5jdGlvbiB2aXNpdE5vZGUgKG5vZGUsIGRlcHMpIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5fY29tcG9uZW50cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIHZpc2l0Q29tcG9uZW50KG5vZGUuX2NvbXBvbmVudHNbaV0sIGRlcHMpO1xyXG4gICAgfVxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLl9jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIHZpc2l0Tm9kZShub2RlLl9jaGlsZHJlbltpXSwgZGVwcyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRlc2NlbmRPcFJlZiAoYXNzZXQsIHJlZnMsIGV4Y2x1ZGUsIG9wKSB7XHJcbiAgICBleGNsdWRlLnB1c2goYXNzZXQuX3V1aWQpO1xyXG4gICAgdmFyIGRlcGVuZHMgPSBkZXBlbmRVdGlsLmdldERlcHMoYXNzZXQuX3V1aWQpO1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBkZXBlbmRzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgIHZhciBkZXBlbmRBc3NldCA9IGFzc2V0cy5nZXQoZGVwZW5kc1tpXSk7XHJcbiAgICAgICAgaWYgKGRlcGVuZEFzc2V0KSB7XHJcbiAgICAgICAgICAgIGxldCB1dWlkID0gZGVwZW5kQXNzZXQuX3V1aWQ7XHJcbiAgICAgICAgICAgIGlmICghKHV1aWQgaW4gcmVmcykpIHsgXHJcbiAgICAgICAgICAgICAgICByZWZzW3V1aWRdID0gZGVwZW5kQXNzZXQucmVmQ291bnQgKyBvcDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlZnNbdXVpZF0gKz0gb3A7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGV4Y2x1ZGUuaW5jbHVkZXModXVpZCkpIGNvbnRpbnVlOyBcclxuICAgICAgICAgICAgZGVzY2VuZE9wUmVmKGRlcGVuZEFzc2V0LCByZWZzLCBleGNsdWRlLCBvcCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjaGVja0NpcmN1bGFyUmVmZXJlbmNlIChhc3NldCkge1xyXG4gICAgLy8gY2hlY2sgY2lyY3VsYXIgcmVmZXJlbmNlXHJcbiAgICB2YXIgcmVmcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XHJcbiAgICByZWZzW2Fzc2V0Ll91dWlkXSA9IGFzc2V0LnJlZkNvdW50O1xyXG4gICAgZGVzY2VuZE9wUmVmKGFzc2V0LCByZWZzLCBfdGVtcCwgLTEpO1xyXG4gICAgX3RlbXAubGVuZ3RoID0gMDtcclxuICAgIGlmIChyZWZzW2Fzc2V0Ll91dWlkXSAhPT0gMCkgcmV0dXJuIHJlZnNbYXNzZXQuX3V1aWRdO1xyXG5cclxuICAgIGZvciAobGV0IHV1aWQgaW4gcmVmcykge1xyXG4gICAgICAgIGlmIChyZWZzW3V1aWRdICE9PSAwKSB7XHJcbiAgICAgICAgICAgIGRlc2NlbmRPcFJlZihhc3NldHMuZ2V0KHV1aWQpLCByZWZzLCBfdGVtcCwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgX3RlbXAubGVuZ3RoID0gMDtcclxuXHJcbiAgICByZXR1cm4gcmVmc1thc3NldC5fdXVpZF07XHJcbn1cclxuXHJcbnZhciBfcGVyc2lzdE5vZGVEZXBzID0gbmV3IENhY2hlKCk7XHJcbnZhciBfdG9EZWxldGUgPSBuZXcgQ2FjaGUoKTtcclxudmFyIGV2ZW50TGlzdGVuZXIgPSBmYWxzZTtcclxuXHJcbmZ1bmN0aW9uIGZyZWVBc3NldHMgKCkge1xyXG4gICAgZXZlbnRMaXN0ZW5lciA9IGZhbHNlO1xyXG4gICAgX3RvRGVsZXRlLmZvckVhY2goZnVuY3Rpb24gKGFzc2V0KSB7XHJcbiAgICAgICAgcmVsZWFzZU1hbmFnZXIuX2ZyZWUoYXNzZXQpO1xyXG4gICAgfSk7XHJcbiAgICBfdG9EZWxldGUuY2xlYXIoKTtcclxufVxyXG5cclxudmFyIHJlbGVhc2VNYW5hZ2VyID0ge1xyXG4gICAgaW5pdCAoKSB7XHJcbiAgICAgICAgX3BlcnNpc3ROb2RlRGVwcy5jbGVhcigpO1xyXG4gICAgICAgIF90b0RlbGV0ZS5jbGVhcigpO1xyXG4gICAgfSxcclxuXHJcbiAgICBfYWRkUGVyc2lzdE5vZGVSZWYgKG5vZGUpIHtcclxuICAgICAgICB2YXIgZGVwcyA9IFtdO1xyXG4gICAgICAgIHZpc2l0Tm9kZShub2RlLCBkZXBzKTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGRlcHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBkZXBlbmRBc3NldCA9IGFzc2V0cy5nZXQoZGVwc1tpXSk7XHJcbiAgICAgICAgICAgIGlmIChkZXBlbmRBc3NldCkge1xyXG4gICAgICAgICAgICAgICAgZGVwZW5kQXNzZXQuYWRkUmVmKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgX3BlcnNpc3ROb2RlRGVwcy5hZGQobm9kZS51dWlkLCBkZXBzKTtcclxuICAgIH0sXHJcblxyXG4gICAgX3JlbW92ZVBlcnNpc3ROb2RlUmVmIChub2RlKSB7XHJcbiAgICAgICAgaWYgKF9wZXJzaXN0Tm9kZURlcHMuaGFzKG5vZGUudXVpZCkpIHtcclxuICAgICAgICAgICAgdmFyIGRlcHMgPSBfcGVyc2lzdE5vZGVEZXBzLmdldChub2RlLnV1aWQpO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGRlcHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZGVwZW5kQXNzZXQgPSBhc3NldHMuZ2V0KGRlcHNbaV0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRlcGVuZEFzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVwZW5kQXNzZXQuZGVjUmVmKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgX3BlcnNpc3ROb2RlRGVwcy5yZW1vdmUobm9kZS51dWlkKTtcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIC8vIGRvIGF1dG8gcmVsZWFzZVxyXG4gICAgX2F1dG9SZWxlYXNlIChvbGRTY2VuZSwgbmV3U2NlbmUsIHBlcnNpc3ROb2RlcykgeyBcclxuXHJcbiAgICAgICAgaWYgKG9sZFNjZW5lKSB7XHJcbiAgICAgICAgICAgIHZhciBjaGlsZHMgPSBkZXBlbmRVdGlsLmdldERlcHMob2xkU2NlbmUuX2lkKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBjaGlsZHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgYXNzZXQgPSBhc3NldHMuZ2V0KGNoaWxkc1tpXSk7XHJcbiAgICAgICAgICAgICAgICBhc3NldCAmJiBhc3NldC5kZWNSZWYoQ0NfVEVTVCB8fCBvbGRTY2VuZS5hdXRvUmVsZWFzZUFzc2V0cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGRlcGVuZGVuY2llcyA9IGRlcGVuZFV0aWwuX2RlcGVuZHMuZ2V0KG9sZFNjZW5lLl9pZCk7XHJcbiAgICAgICAgICAgIGlmIChkZXBlbmRlbmNpZXMgJiYgZGVwZW5kZW5jaWVzLnBlcnNpc3REZXBzKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGVyc2lzdERlcHMgPSBkZXBlbmRlbmNpZXMucGVyc2lzdERlcHM7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHBlcnNpc3REZXBzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBhc3NldCA9IGFzc2V0cy5nZXQocGVyc2lzdERlcHNbaV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGFzc2V0ICYmIGFzc2V0LmRlY1JlZihDQ19URVNUIHx8IG9sZFNjZW5lLmF1dG9SZWxlYXNlQXNzZXRzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvbGRTY2VuZS5faWQgIT09IG5ld1NjZW5lLl9pZCAmJiBkZXBlbmRVdGlsLnJlbW92ZShvbGRTY2VuZS5faWQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdmFyIHNjZW5lRGVwcyA9IGRlcGVuZFV0aWwuX2RlcGVuZHMuZ2V0KG5ld1NjZW5lLl9pZCk7XHJcbiAgICAgICAgc2NlbmVEZXBzICYmIChzY2VuZURlcHMucGVyc2lzdERlcHMgPSBbXSk7XHJcbiAgICAgICAgLy8gdHJhbnNmZXIgcmVmcyBmcm9tIHBlcnNpc3Qgbm9kZXMgdG8gbmV3IHNjZW5lXHJcbiAgICAgICAgZm9yIChsZXQga2V5IGluIHBlcnNpc3ROb2Rlcykge1xyXG4gICAgICAgICAgICB2YXIgbm9kZSA9IHBlcnNpc3ROb2Rlc1trZXldO1xyXG4gICAgICAgICAgICB2YXIgZGVwcyA9IF9wZXJzaXN0Tm9kZURlcHMuZ2V0KG5vZGUudXVpZCk7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gZGVwcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBkZXBlbmRBc3NldCA9IGFzc2V0cy5nZXQoZGVwc1tpXSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kQXNzZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICBkZXBlbmRBc3NldC5hZGRSZWYoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoc2NlbmVEZXBzKSB7XHJcbiAgICAgICAgICAgICAgICBzY2VuZURlcHMucGVyc2lzdERlcHMucHVzaC5hcHBseShzY2VuZURlcHMucGVyc2lzdERlcHMsIGRlcHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBfZnJlZSAoYXNzZXQsIGZvcmNlKSB7XHJcbiAgICAgICAgX3RvRGVsZXRlLnJlbW92ZShhc3NldC5fdXVpZCk7XHJcblxyXG4gICAgICAgIGlmICghY2MuaXNWYWxpZChhc3NldCwgdHJ1ZSkpIHJldHVybjtcclxuXHJcbiAgICAgICAgaWYgKCFmb3JjZSkge1xyXG4gICAgICAgICAgICBpZiAoYXNzZXQucmVmQ291bnQgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hlY2tDaXJjdWxhclJlZmVyZW5jZShhc3NldCkgPiAwKSByZXR1cm47IFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgLy8gcmVtb3ZlIGZyb20gY2FjaGVcclxuICAgICAgICBhc3NldHMucmVtb3ZlKGFzc2V0Ll91dWlkKTtcclxuICAgICAgICB2YXIgZGVwZW5kcyA9IGRlcGVuZFV0aWwuZ2V0RGVwcyhhc3NldC5fdXVpZCk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBkZXBlbmRzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgICAgICB2YXIgZGVwZW5kQXNzZXQgPSBhc3NldHMuZ2V0KGRlcGVuZHNbaV0pO1xyXG4gICAgICAgICAgICBpZiAoZGVwZW5kQXNzZXQpIHtcclxuICAgICAgICAgICAgICAgIGRlcGVuZEFzc2V0LmRlY1JlZihmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICByZWxlYXNlTWFuYWdlci5fZnJlZShkZXBlbmRBc3NldCwgZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFzc2V0LmRlc3Ryb3koKTtcclxuICAgICAgICBkZXBlbmRVdGlsLnJlbW92ZShhc3NldC5fdXVpZCk7XHJcbiAgICB9LFxyXG5cclxuICAgIHRyeVJlbGVhc2UgKGFzc2V0LCBmb3JjZSkge1xyXG4gICAgICAgIGlmICghKGFzc2V0IGluc3RhbmNlb2YgY2MuQXNzZXQpKSByZXR1cm47XHJcbiAgICAgICAgaWYgKGZvcmNlKSB7XHJcbiAgICAgICAgICAgIHJlbGVhc2VNYW5hZ2VyLl9mcmVlKGFzc2V0LCBmb3JjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBfdG9EZWxldGUuYWRkKGFzc2V0Ll91dWlkLCBhc3NldCk7XHJcbiAgICAgICAgICAgIGlmICghZXZlbnRMaXN0ZW5lcikge1xyXG4gICAgICAgICAgICAgICAgZXZlbnRMaXN0ZW5lciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBjYWxsSW5OZXh0VGljayhmcmVlQXNzZXRzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gcmVsZWFzZU1hbmFnZXI7Il0sInNvdXJjZVJvb3QiOiIvIn0=