
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/asset-manager/font-loader.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2019 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var textUtils = require('../utils/text-utils');

var _canvasContext = null; // letter symbol number CJK

var _testString = "BES bswy:->@123\u4E01\u3041\u1101";

var _fontFaces = Object.create(null);

var _intervalId = -1;

var _loadingFonts = []; // 3 seconds timeout

var _timeout = 3000; // Refer to https://github.com/typekit/webfontloader/blob/master/src/core/fontwatcher.js

var useNativeCheck = function () {
  var nativeCheck = undefined;
  return function () {
    if (nativeCheck === undefined) {
      if (!!window.FontFace) {
        var match = /Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent);
        var safari10Match = /OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent) && /Apple/.exec(window.navigator.vendor);

        if (match) {
          nativeCheck = parseInt(match[1], 10) > 42;
        } else if (safari10Match) {
          nativeCheck = false;
        } else {
          nativeCheck = true;
        }
      } else {
        nativeCheck = false;
      }
    }

    return nativeCheck;
  };
}();

function _checkFontLoaded() {
  var allFontsLoaded = true;
  var now = Date.now();

  for (var i = _loadingFonts.length - 1; i >= 0; i--) {
    var fontLoadHandle = _loadingFonts[i];
    var fontFamily = fontLoadHandle.fontFamilyName; // load timeout

    if (now - fontLoadHandle.startTime > _timeout) {
      cc.warnID(4933, fontFamily);
      fontLoadHandle.onComplete(null, fontFamily);

      _loadingFonts.splice(i, 1);

      continue;
    }

    var oldWidth = fontLoadHandle.refWidth;
    var fontDesc = '40px ' + fontFamily;
    _canvasContext.font = fontDesc;
    var newWidth = textUtils.safeMeasureText(_canvasContext, _testString, fontDesc); // loaded successfully

    if (oldWidth !== newWidth) {
      _loadingFonts.splice(i, 1);

      fontLoadHandle.onComplete(null, fontFamily);
    } else {
      allFontsLoaded = false;
    }
  }

  if (allFontsLoaded) {
    clearInterval(_intervalId);
    _intervalId = -1;
  }
} // refer to https://github.com/typekit/webfontloader/blob/master/src/core/nativefontwatchrunner.js


function nativeCheckFontLoaded(start, font, callback) {
  var loader = new Promise(function (resolve, reject) {
    var check = function check() {
      var now = Date.now();

      if (now - start >= _timeout) {
        reject();
      } else {
        document.fonts.load('40px ' + font).then(function (fonts) {
          if (fonts.length >= 1) {
            resolve();
          } else {
            setTimeout(check, 100);
          }
        }, function () {
          reject();
        });
      }
    };

    check();
  });
  var timeoutId = null,
      timer = new Promise(function (resolve, reject) {
    timeoutId = setTimeout(reject, _timeout);
  });
  Promise.race([timer, loader]).then(function () {
    if (timeoutId) {
      clearTimeout(timeoutId);
      timeoutId = null;
    }

    callback(null, font);
  }, function () {
    cc.warnID(4933, font);
    callback(null, font);
  });
}

var fontLoader = {
  loadFont: function loadFont(url, options, onComplete) {
    var fontFamilyName = fontLoader._getFontFamily(url); // Already loaded fonts


    if (_fontFaces[fontFamilyName]) {
      return onComplete(null, fontFamilyName);
    }

    if (!_canvasContext) {
      var labelCanvas = document.createElement('canvas');
      labelCanvas.width = 100;
      labelCanvas.height = 100;
      _canvasContext = labelCanvas.getContext('2d');
    } // Default width reference to test whether new font is loaded correctly


    var fontDesc = '40px ' + fontFamilyName;
    _canvasContext.font = fontDesc;
    var refWidth = textUtils.safeMeasureText(_canvasContext, _testString, fontDesc); // Setup font face style

    var fontStyle = document.createElement("style");
    fontStyle.type = "text/css";
    var fontStr = "";
    if (isNaN(fontFamilyName - 0)) fontStr += "@font-face { font-family:" + fontFamilyName + "; src:";else fontStr += "@font-face { font-family:'" + fontFamilyName + "'; src:";
    fontStr += "url('" + url + "');";
    fontStyle.textContent = fontStr + "}";
    document.body.appendChild(fontStyle); // Preload font with div

    var preloadDiv = document.createElement("div");
    var divStyle = preloadDiv.style;
    divStyle.fontFamily = fontFamilyName;
    preloadDiv.innerHTML = ".";
    divStyle.position = "absolute";
    divStyle.left = "-100px";
    divStyle.top = "-100px";
    document.body.appendChild(preloadDiv);

    if (useNativeCheck()) {
      nativeCheckFontLoaded(Date.now(), fontFamilyName, onComplete);
    } else {
      // Save loading font
      var fontLoadHandle = {
        fontFamilyName: fontFamilyName,
        refWidth: refWidth,
        onComplete: onComplete,
        startTime: Date.now()
      };

      _loadingFonts.push(fontLoadHandle);

      if (_intervalId === -1) {
        _intervalId = setInterval(_checkFontLoaded, 100);
      }
    }

    _fontFaces[fontFamilyName] = fontStyle;
  },
  _getFontFamily: function _getFontFamily(fontHandle) {
    var ttfIndex = fontHandle.lastIndexOf(".ttf");
    if (ttfIndex === -1) return fontHandle;
    var slashPos = fontHandle.lastIndexOf("/");
    var fontFamilyName;

    if (slashPos === -1) {
      fontFamilyName = fontHandle.substring(0, ttfIndex) + "_LABEL";
    } else {
      fontFamilyName = fontHandle.substring(slashPos + 1, ttfIndex) + "_LABEL";
    }

    if (fontFamilyName.indexOf(' ') !== -1) {
      fontFamilyName = '"' + fontFamilyName + '"';
    }

    return fontFamilyName;
  }
};
module.exports = fontLoader;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXZcXGNvY29zMmRcXGNvcmVcXGFzc2V0LW1hbmFnZXJcXGZvbnQtbG9hZGVyLmpzIl0sIm5hbWVzIjpbInRleHRVdGlscyIsInJlcXVpcmUiLCJfY2FudmFzQ29udGV4dCIsIl90ZXN0U3RyaW5nIiwiX2ZvbnRGYWNlcyIsIk9iamVjdCIsImNyZWF0ZSIsIl9pbnRlcnZhbElkIiwiX2xvYWRpbmdGb250cyIsIl90aW1lb3V0IiwidXNlTmF0aXZlQ2hlY2siLCJuYXRpdmVDaGVjayIsInVuZGVmaW5lZCIsIndpbmRvdyIsIkZvbnRGYWNlIiwibWF0Y2giLCJleGVjIiwibmF2aWdhdG9yIiwidXNlckFnZW50Iiwic2FmYXJpMTBNYXRjaCIsInZlbmRvciIsInBhcnNlSW50IiwiX2NoZWNrRm9udExvYWRlZCIsImFsbEZvbnRzTG9hZGVkIiwibm93IiwiRGF0ZSIsImkiLCJsZW5ndGgiLCJmb250TG9hZEhhbmRsZSIsImZvbnRGYW1pbHkiLCJmb250RmFtaWx5TmFtZSIsInN0YXJ0VGltZSIsImNjIiwid2FybklEIiwib25Db21wbGV0ZSIsInNwbGljZSIsIm9sZFdpZHRoIiwicmVmV2lkdGgiLCJmb250RGVzYyIsImZvbnQiLCJuZXdXaWR0aCIsInNhZmVNZWFzdXJlVGV4dCIsImNsZWFySW50ZXJ2YWwiLCJuYXRpdmVDaGVja0ZvbnRMb2FkZWQiLCJzdGFydCIsImNhbGxiYWNrIiwibG9hZGVyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJjaGVjayIsImRvY3VtZW50IiwiZm9udHMiLCJsb2FkIiwidGhlbiIsInNldFRpbWVvdXQiLCJ0aW1lb3V0SWQiLCJ0aW1lciIsInJhY2UiLCJjbGVhclRpbWVvdXQiLCJmb250TG9hZGVyIiwibG9hZEZvbnQiLCJ1cmwiLCJvcHRpb25zIiwiX2dldEZvbnRGYW1pbHkiLCJsYWJlbENhbnZhcyIsImNyZWF0ZUVsZW1lbnQiLCJ3aWR0aCIsImhlaWdodCIsImdldENvbnRleHQiLCJmb250U3R5bGUiLCJ0eXBlIiwiZm9udFN0ciIsImlzTmFOIiwidGV4dENvbnRlbnQiLCJib2R5IiwiYXBwZW5kQ2hpbGQiLCJwcmVsb2FkRGl2IiwiZGl2U3R5bGUiLCJzdHlsZSIsImlubmVySFRNTCIsInBvc2l0aW9uIiwibGVmdCIsInRvcCIsInB1c2giLCJzZXRJbnRlcnZhbCIsImZvbnRIYW5kbGUiLCJ0dGZJbmRleCIsImxhc3RJbmRleE9mIiwic2xhc2hQb3MiLCJzdWJzdHJpbmciLCJpbmRleE9mIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLElBQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLHFCQUFELENBQXpCOztBQUVBLElBQUlDLGNBQWMsR0FBRyxJQUFyQixFQUNBOztBQUNBLElBQUlDLFdBQVcsR0FBRyxtQ0FBbEI7O0FBRUEsSUFBSUMsVUFBVSxHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYyxJQUFkLENBQWpCOztBQUNBLElBQUlDLFdBQVcsR0FBRyxDQUFDLENBQW5COztBQUNBLElBQUlDLGFBQWEsR0FBRyxFQUFwQixFQUNBOztBQUNBLElBQUlDLFFBQVEsR0FBRyxJQUFmLEVBRUE7O0FBQ0EsSUFBSUMsY0FBYyxHQUFJLFlBQVk7QUFDOUIsTUFBSUMsV0FBVyxHQUFHQyxTQUFsQjtBQUNBLFNBQU8sWUFBWTtBQUNmLFFBQUlELFdBQVcsS0FBS0MsU0FBcEIsRUFBK0I7QUFDM0IsVUFBSSxDQUFDLENBQUNDLE1BQU0sQ0FBQ0MsUUFBYixFQUF1QjtBQUNuQixZQUFJQyxLQUFLLEdBQUcsd0JBQXdCQyxJQUF4QixDQUE2QkgsTUFBTSxDQUFDSSxTQUFQLENBQWlCQyxTQUE5QyxDQUFaO0FBQ0EsWUFBSUMsYUFBYSxHQUFHLDhCQUE4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QUFBQSxVQUFVLENBQUMwQixjQUFELENBQVYsR0FBNkJ3QyxTQUE3QjtBQUNILEdBNURZO0FBOERiTixFQUFBQSxjQUFjLEVBQUUsd0JBQVVzQixVQUFWLEVBQXNCO0FBQ2xDLFFBQUlDLFFBQVEsR0FBR0QsVUFBVSxDQUFDRSxXQUFYLENBQXVCLE1BQXZCLENBQWY7QUFDQSxRQUFJRCxRQUFRLEtBQUssQ0FBQyxDQUFsQixFQUFxQixPQUFPRCxVQUFQO0FBRXJCLFFBQUlHLFFBQVEsR0FBR0gsVUFBVSxDQUFDRSxXQUFYLENBQXVCLEdBQXZCLENBQWY7QUFDQSxRQUFJMUQsY0FBSjs7QUFDQSxRQUFJMkQsUUFBUSxLQUFLLENBQUMsQ0FBbEIsRUFBcUI7QUFDakIzRCxNQUFBQSxjQUFjLEdBQUd3RCxVQUFVLENBQUNJLFNBQVgsQ0FBcUIsQ0FBckIsRUFBd0JILFFBQXhCLElBQW9DLFFBQXJEO0FBQ0gsS0FGRCxNQUVPO0FBQ0h6RCxNQUFBQSxjQUFjLEdBQUd3RCxVQUFVLENBQUNJLFNBQVgsQ0FBcUJELFFBQVEsR0FBRyxDQUFoQyxFQUFtQ0YsUUFBbkMsSUFBK0MsUUFBaEU7QUFDSDs7QUFDRCxRQUFJekQsY0FBYyxDQUFDNkQsT0FBZixDQUF1QixHQUF2QixNQUFnQyxDQUFDLENBQXJDLEVBQXdDO0FBQ3BDN0QsTUFBQUEsY0FBYyxHQUFHLE1BQU1BLGNBQU4sR0FBdUIsR0FBeEM7QUFDSDs7QUFDRCxXQUFPQSxjQUFQO0FBQ0g7QUE3RVksQ0FBakI7QUFnRkE4RCxNQUFNLENBQUNDLE9BQVAsR0FBaUJqQyxVQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXHJcbiBDb3B5cmlnaHQgKGMpIDIwMTkgWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXHJcblxyXG4gaHR0cHM6Ly93d3cuY29jb3MuY29tL1xyXG5cclxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcclxuIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZW5naW5lIHNvdXJjZSBjb2RlICh0aGUgXCJTb2Z0d2FyZVwiKSwgYSBsaW1pdGVkLFxyXG4gIHdvcmxkd2lkZSwgcm95YWx0eS1mcmVlLCBub24tYXNzaWduYWJsZSwgcmV2b2NhYmxlIGFuZCBub24tZXhjbHVzaXZlIGxpY2Vuc2VcclxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXHJcbiAgbm90IHVzZSBDb2NvcyBDcmVhdG9yIHNvZnR3YXJlIGZvciBkZXZlbG9waW5nIG90aGVyIHNvZnR3YXJlIG9yIHRvb2xzIHRoYXQnc1xyXG4gIHVzZWQgZm9yIGRldmVsb3BpbmcgZ2FtZXMuIFlvdSBhcmUgbm90IGdyYW50ZWQgdG8gcHVibGlzaCwgZGlzdHJpYnV0ZSxcclxuICBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cclxuXHJcbiBUaGUgc29mdHdhcmUgb3IgdG9vbHMgaW4gdGhpcyBMaWNlbnNlIEFncmVlbWVudCBhcmUgbGljZW5zZWQsIG5vdCBzb2xkLlxyXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cclxuXHJcbiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXHJcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcclxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxyXG4gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxyXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcclxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cclxuIFRIRSBTT0ZUV0FSRS5cclxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXHJcblxyXG5jb25zdCB0ZXh0VXRpbHMgPSByZXF1aXJlKCcuLi91dGlscy90ZXh0LXV0aWxzJyk7XHJcblxyXG5sZXQgX2NhbnZhc0NvbnRleHQgPSBudWxsO1xyXG4vLyBsZXR0ZXIgc3ltYm9sIG51bWJlciBDSktcclxubGV0IF90ZXN0U3RyaW5nID0gXCJCRVMgYnN3eTotPkAxMjNcXHU0RTAxXFx1MzA0MVxcdTExMDFcIjtcclxuXHJcbmxldCBfZm9udEZhY2VzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcclxubGV0IF9pbnRlcnZhbElkID0gLTE7XHJcbmxldCBfbG9hZGluZ0ZvbnRzID0gW107XHJcbi8vIDMgc2Vjb25kcyB0aW1lb3V0XHJcbmxldCBfdGltZW91dCA9IDMwMDA7XHJcblxyXG4vLyBSZWZlciB0byBodHRwczovL2dpdGh1Yi5jb20vdHlwZWtpdC93ZWJmb250bG9hZGVyL2Jsb2IvbWFzdGVyL3NyYy9jb3JlL2ZvbnR3YXRjaGVyLmpzXHJcbmxldCB1c2VOYXRpdmVDaGVjayA9IChmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgbmF0aXZlQ2hlY2sgPSB1bmRlZmluZWQ7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChuYXRpdmVDaGVjayA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlmICghIXdpbmRvdy5Gb250RmFjZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gL0dlY2tvLipGaXJlZm94XFwvKFxcZCspLy5leGVjKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KTtcclxuICAgICAgICAgICAgICAgIHZhciBzYWZhcmkxME1hdGNoID0gL09TIFguKlZlcnNpb25cXC8xMFxcLi4qU2FmYXJpLy5leGVjKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KSAmJiAvQXBwbGUvLmV4ZWMod2luZG93Lm5hdmlnYXRvci52ZW5kb3IpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSBwYXJzZUludChtYXRjaFsxXSwgMTApID4gNDI7XHJcbiAgICAgICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc2FmYXJpMTBNYXRjaCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hdGl2ZUNoZWNrID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5hdGl2ZUNoZWNrO1xyXG4gICAgICAgIFxyXG4gICAgfVxyXG59KSgpO1xyXG5cclxuZnVuY3Rpb24gX2NoZWNrRm9udExvYWRlZCAoKSB7XHJcbiAgICBsZXQgYWxsRm9udHNMb2FkZWQgPSB0cnVlO1xyXG4gICAgbGV0IG5vdyA9IERhdGUubm93KCk7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IF9sb2FkaW5nRm9udHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgICBsZXQgZm9udExvYWRIYW5kbGUgPSBfbG9hZGluZ0ZvbnRzW2ldO1xyXG4gICAgICAgIGxldCBmb250RmFtaWx5ID0gZm9udExvYWRIYW5kbGUuZm9udEZhbWlseU5hbWU7XHJcbiAgICAgICAgLy8gbG9hZCB0aW1lb3V0XHJcbiAgICAgICAgaWYgKG5vdyAtIGZvbnRMb2FkSGFuZGxlLnN0YXJ0VGltZSA+IF90aW1lb3V0KSB7XHJcbiAgICAgICAgICAgIGNjLndhcm5JRCg0OTMzLCBmb250RmFtaWx5KTtcclxuICAgICAgICAgICAgZm9udExvYWRIYW5kbGUub25Db21wbGV0ZShudWxsLCBmb250RmFtaWx5KTtcclxuICAgICAgICAgICAgX2xvYWRpbmdGb250cy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IG9sZFdpZHRoID0gZm9udExvYWRIYW5kbGUucmVmV2lkdGg7XHJcbiAgICAgICAgbGV0IGZvbnREZXNjID0gJzQwcHggJyArIGZvbnRGYW1pbHk7XHJcbiAgICAgICAgX2NhbnZhc0NvbnRleHQuZm9udCA9IGZvbnREZXNjO1xyXG4gICAgICAgIGxldCBuZXdXaWR0aCA9IHRleHRVdGlscy5zYWZlTWVhc3VyZVRleHQoX2NhbnZhc0NvbnRleHQsIF90ZXN0U3RyaW5nLCBmb250RGVzYyk7XHJcbiAgICAgICAgLy8gbG9hZGVkIHN1Y2Nlc3NmdWxseVxyXG4gICAgICAgIGlmIChvbGRXaWR0aCAhPT0gbmV3V2lkdGgpIHtcclxuICAgICAgICAgICAgX2xvYWRpbmdGb250cy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgIGZvbnRMb2FkSGFuZGxlLm9uQ29tcGxldGUobnVsbCwgZm9udEZhbWlseSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBhbGxGb250c0xvYWRlZCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoYWxsRm9udHNMb2FkZWQpIHtcclxuICAgICAgICBjbGVhckludGVydmFsKF9pbnRlcnZhbElkKTtcclxuICAgICAgICBfaW50ZXJ2YWxJZCA9IC0xO1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyByZWZlciB0byBodHRwczovL2dpdGh1Yi5jb20vdHlwZWtpdC93ZWJmb250bG9hZGVyL2Jsb2IvbWFzdGVyL3NyYy9jb3JlL25hdGl2ZWZvbnR3YXRjaHJ1bm5lci5qc1xyXG5mdW5jdGlvbiBuYXRpdmVDaGVja0ZvbnRMb2FkZWQgKHN0YXJ0LCBmb250LCBjYWxsYmFjaykge1xyXG4gICAgdmFyIGxvYWRlciA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICB2YXIgY2hlY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpO1xyXG5cclxuICAgICAgICAgICAgaWYgKG5vdyAtIHN0YXJ0ID49IF90aW1lb3V0KSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoKTtcclxuICAgICAgICAgICAgfSBcclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5mb250cy5sb2FkKCc0MHB4ICcgKyBmb250KS50aGVuKGZ1bmN0aW9uIChmb250cykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb250cy5sZW5ndGggPj0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBcclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChjaGVjaywgMTAwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNoZWNrKCk7XHJcbiAgICB9KTtcclxuICBcclxuICAgIHZhciB0aW1lb3V0SWQgPSBudWxsLFxyXG4gICAgdGltZXIgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dChyZWplY3QsIF90aW1lb3V0KTtcclxuICAgIH0pO1xyXG4gIFxyXG4gICAgUHJvbWlzZS5yYWNlKFt0aW1lciwgbG9hZGVyXSkudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRpbWVvdXRJZCkge1xyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcclxuICAgICAgICAgICAgdGltZW91dElkID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgZm9udCk7XHJcbiAgICB9LCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgY2Mud2FybklEKDQ5MzMsIGZvbnQpO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGZvbnQpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbnZhciBmb250TG9hZGVyID0ge1xyXG4gICAgbG9hZEZvbnQ6IGZ1bmN0aW9uICh1cmwsIG9wdGlvbnMsIG9uQ29tcGxldGUpIHtcclxuICAgICAgICBsZXQgZm9udEZhbWlseU5hbWUgPSBmb250TG9hZGVyLl9nZXRGb250RmFtaWx5KHVybCk7XHJcblxyXG4gICAgICAgIC8vIEFscmVhZHkgbG9hZGVkIGZvbnRzXHJcbiAgICAgICAgaWYgKF9mb250RmFjZXNbZm9udEZhbWlseU5hbWVdKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvbkNvbXBsZXRlKG51bGwsIGZvbnRGYW1pbHlOYW1lKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghX2NhbnZhc0NvbnRleHQpIHtcclxuICAgICAgICAgICAgbGV0IGxhYmVsQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XHJcbiAgICAgICAgICAgIGxhYmVsQ2FudmFzLndpZHRoID0gMTAwO1xyXG4gICAgICAgICAgICBsYWJlbENhbnZhcy5oZWlnaHQgPSAxMDA7XHJcbiAgICAgICAgICAgIF9jYW52YXNDb250ZXh0ID0gbGFiZWxDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gRGVmYXVsdCB3aWR0aCByZWZlcmVuY2UgdG8gdGVzdCB3aGV0aGVyIG5ldyBmb250IGlzIGxvYWRlZCBjb3JyZWN0bHlcclxuICAgICAgICBsZXQgZm9udERlc2MgPSAnNDBweCAnICsgZm9udEZhbWlseU5hbWU7XHJcbiAgICAgICAgX2NhbnZhc0NvbnRleHQuZm9udCA9IGZvbnREZXNjO1xyXG4gICAgICAgIGxldCByZWZXaWR0aCA9IHRleHRVdGlscy5zYWZlTWVhc3VyZVRleHQoX2NhbnZhc0NvbnRleHQsIF90ZXN0U3RyaW5nLCBmb250RGVzYyk7XHJcblxyXG4gICAgICAgIC8vIFNldHVwIGZvbnQgZmFjZSBzdHlsZVxyXG4gICAgICAgIGxldCBmb250U3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3R5bGVcIik7XHJcbiAgICAgICAgZm9udFN0eWxlLnR5cGUgPSBcInRleHQvY3NzXCI7XHJcbiAgICAgICAgbGV0IGZvbnRTdHIgPSBcIlwiO1xyXG4gICAgICAgIGlmIChpc05hTihmb250RmFtaWx5TmFtZSAtIDApKVxyXG4gICAgICAgICAgICBmb250U3RyICs9IFwiQGZvbnQtZmFjZSB7IGZvbnQtZmFtaWx5OlwiICsgZm9udEZhbWlseU5hbWUgKyBcIjsgc3JjOlwiO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgZm9udFN0ciArPSBcIkBmb250LWZhY2UgeyBmb250LWZhbWlseTonXCIgKyBmb250RmFtaWx5TmFtZSArIFwiJzsgc3JjOlwiO1xyXG4gICAgICAgIGZvbnRTdHIgKz0gXCJ1cmwoJ1wiICsgdXJsICsgXCInKTtcIjtcclxuICAgICAgICBmb250U3R5bGUudGV4dENvbnRlbnQgPSBmb250U3RyICsgXCJ9XCI7XHJcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmb250U3R5bGUpO1xyXG5cclxuICAgICAgICAvLyBQcmVsb2FkIGZvbnQgd2l0aCBkaXZcclxuICAgICAgICBsZXQgcHJlbG9hZERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgbGV0IGRpdlN0eWxlID0gcHJlbG9hZERpdi5zdHlsZTtcclxuICAgICAgICBkaXZTdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseU5hbWU7XHJcbiAgICAgICAgcHJlbG9hZERpdi5pbm5lckhUTUwgPSBcIi5cIjtcclxuICAgICAgICBkaXZTdHlsZS5wb3NpdGlvbiA9IFwiYWJzb2x1dGVcIjtcclxuICAgICAgICBkaXZTdHlsZS5sZWZ0ID0gXCItMTAwcHhcIjtcclxuICAgICAgICBkaXZTdHlsZS50b3AgPSBcIi0xMDBweFwiO1xyXG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocHJlbG9hZERpdik7XHJcblxyXG4gICAgICAgIGlmICh1c2VOYXRpdmVDaGVjaygpKSB7XHJcbiAgICAgICAgICAgIG5hdGl2ZUNoZWNrRm9udExvYWRlZChEYXRlLm5vdygpLCBmb250RmFtaWx5TmFtZSwgb25Db21wbGV0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBTYXZlIGxvYWRpbmcgZm9udFxyXG4gICAgICAgICAgICBsZXQgZm9udExvYWRIYW5kbGUgPSB7XHJcbiAgICAgICAgICAgICAgICBmb250RmFtaWx5TmFtZSxcclxuICAgICAgICAgICAgICAgIHJlZldpZHRoLFxyXG4gICAgICAgICAgICAgICAgb25Db21wbGV0ZSxcclxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZTogRGF0ZS5ub3coKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF9sb2FkaW5nRm9udHMucHVzaChmb250TG9hZEhhbmRsZSk7XHJcbiAgICAgICAgICAgIGlmIChfaW50ZXJ2YWxJZCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIF9pbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoX2NoZWNrRm9udExvYWRlZCwgMTAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBfZm9udEZhY2VzW2ZvbnRGYW1pbHlOYW1lXSA9IGZvbnRTdHlsZTtcclxuICAgIH0sXHJcblxyXG4gICAgX2dldEZvbnRGYW1pbHk6IGZ1bmN0aW9uIChmb250SGFuZGxlKSB7XHJcbiAgICAgICAgdmFyIHR0ZkluZGV4ID0gZm9udEhhbmRsZS5sYXN0SW5kZXhPZihcIi50dGZcIik7XHJcbiAgICAgICAgaWYgKHR0ZkluZGV4ID09PSAtMSkgcmV0dXJuIGZvbnRIYW5kbGU7XHJcblxyXG4gICAgICAgIHZhciBzbGFzaFBvcyA9IGZvbnRIYW5kbGUubGFzdEluZGV4T2YoXCIvXCIpO1xyXG4gICAgICAgIHZhciBmb250RmFtaWx5TmFtZTtcclxuICAgICAgICBpZiAoc2xhc2hQb3MgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIGZvbnRGYW1pbHlOYW1lID0gZm9udEhhbmRsZS5zdWJzdHJpbmcoMCwgdHRmSW5kZXgpICsgXCJfTEFCRUxcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmb250RmFtaWx5TmFtZSA9IGZvbnRIYW5kbGUuc3Vic3RyaW5nKHNsYXNoUG9zICsgMSwgdHRmSW5kZXgpICsgXCJfTEFCRUxcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGZvbnRGYW1pbHlOYW1lLmluZGV4T2YoJyAnKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgZm9udEZhbWlseU5hbWUgPSAnXCInICsgZm9udEZhbWlseU5hbWUgKyAnXCInO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZm9udEZhbWlseU5hbWU7XHJcbiAgICB9XHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IGZvbnRMb2FkZXIiXSwic291cmNlUm9vdCI6Ii8ifQ==