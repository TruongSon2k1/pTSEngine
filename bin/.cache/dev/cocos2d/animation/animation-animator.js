
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/animation/animation-animator.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
 worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
 not use Cocos Creator software for developing other software or tools that's
 used for developing games. You are not granted to publish, distribute,
 sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var js = cc.js;

var Playable = require('./playable');

var _require = require('./animation-curves'),
    EventAnimCurve = _require.EventAnimCurve,
    EventInfo = _require.EventInfo;

var WrapModeMask = require('./types').WrapModeMask;

var binarySearch = require('../core/utils/binary-search').binarySearchEpsilon; // The actual animator for Animation Component


function AnimationAnimator(target, animation) {
  Playable.call(this);
  this.target = target;
  this.animation = animation;
  this._anims = new js.array.MutableForwardIterator([]);
}

js.extend(AnimationAnimator, Playable);
var p = AnimationAnimator.prototype;

p.playState = function (state, startTime) {
  if (!state.clip) {
    return;
  }

  if (!state.curveLoaded) {
    initClipData(this.target, state);
  }

  state.animator = this;
  state.play();

  if (typeof startTime === 'number') {
    state.setTime(startTime);
  }

  this.play();
};

p.stopStatesExcept = function (state) {
  var iterator = this._anims;
  var array = iterator.array;

  for (iterator.i = 0; iterator.i < array.length; ++iterator.i) {
    var anim = array[iterator.i];

    if (anim === state) {
      continue;
    }

    this.stopState(anim);
  }
};

p.addAnimation = function (anim) {
  var index = this._anims.array.indexOf(anim);

  if (index === -1) {
    this._anims.push(anim);
  }

  anim._setEventTarget(this.animation);
};

p.removeAnimation = function (anim) {
  var index = this._anims.array.indexOf(anim);

  if (index >= 0) {
    this._anims.fastRemoveAt(index);

    if (this._anims.array.length === 0) {
      this.stop();
    }
  } else {
    cc.errorID(3907);
  }

  anim.animator = null;
};

p.sample = function () {
  var iterator = this._anims;
  var array = iterator.array;

  for (iterator.i = 0; iterator.i < array.length; ++iterator.i) {
    var anim = array[iterator.i];
    anim.sample();
  }
};

p.stopState = function (state) {
  if (state) {
    state.stop();
  }
};

p.pauseState = function (state) {
  if (state) {
    state.pause();
  }
};

p.resumeState = function (state) {
  if (state) {
    state.resume();
  }

  if (this.isPaused) {
    this.resume();
  }
};

p.setStateTime = function (state, time) {
  if (time !== undefined) {
    if (state) {
      state.setTime(time);
      state.sample();
    }
  } else {
    time = state;
    var array = this._anims.array;

    for (var i = 0; i < array.length; ++i) {
      var anim = array[i];
      anim.setTime(time);
      anim.sample();
    }
  }
};

p.onStop = function () {
  var iterator = this._anims;
  var array = iterator.array;

  for (iterator.i = 0; iterator.i < array.length; ++iterator.i) {
    var anim = array[iterator.i];
    anim.stop();
  }
};

p.onPause = function () {
  var array = this._anims.array;

  for (var i = 0; i < array.length; ++i) {
    var anim = array[i];
    anim.pause(); // need to unbind animator to anim, or it maybe cannot be gc.

    anim.animator = null;
  }
};

p.onResume = function () {
  var array = this._anims.array;

  for (var i = 0; i < array.length; ++i) {
    var anim = array[i]; // rebind animator to anim

    anim.animator = this;
    anim.resume();
  }
};

p._reloadClip = function (state) {
  initClipData(this.target, state);
}; // 这个方法应该是 SampledAnimCurve 才能用


function createBatchedProperty(propPath, firstDotIndex, mainValue, animValue) {
  mainValue = mainValue.clone();
  var nextValue = mainValue;
  var leftIndex = firstDotIndex + 1;
  var rightIndex = propPath.indexOf('.', leftIndex); // scan property path

  while (rightIndex !== -1) {
    var nextName = propPath.slice(leftIndex, rightIndex);
    nextValue = nextValue[nextName];
    leftIndex = rightIndex + 1;
    rightIndex = propPath.indexOf('.', leftIndex);
  }

  var lastPropName = propPath.slice(leftIndex);
  nextValue[lastPropName] = animValue;
  return mainValue;
}

if (CC_TEST) {
  cc._Test.createBatchedProperty = createBatchedProperty;
}

function initClipData(root, state) {
  var clip = state.clip;
  state.duration = clip.duration;
  state.speed = clip.speed;
  state.wrapMode = clip.wrapMode;
  state.frameRate = clip.sample;

  if ((state.wrapMode & WrapModeMask.Loop) === WrapModeMask.Loop) {
    state.repeatCount = Infinity;
  } else {
    state.repeatCount = 1;
  }

  var curves = state.curves = clip.createCurves(state, root); // events curve

  var events = clip.events;

  if (!CC_EDITOR && events) {
    var curve;

    for (var i = 0, l = events.length; i < l; i++) {
      if (!curve) {
        curve = new EventAnimCurve();
        curve.target = root;
        curves.push(curve);
      }

      var eventData = events[i];
      var ratio = eventData.frame / state.duration;
      var eventInfo = void 0;
      var index = binarySearch(curve.ratios, ratio);

      if (index >= 0) {
        eventInfo = curve.events[index];
      } else {
        eventInfo = new EventInfo();
        curve.ratios.push(ratio);
        curve.events.push(eventInfo);
      }

      eventInfo.add(eventData.func, eventData.params);
    }
  }
}

if (CC_TEST) {
  cc._Test.initClipData = initClipData;
}

module.exports = AnimationAnimator;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXZcXGNvY29zMmRcXGFuaW1hdGlvblxcYW5pbWF0aW9uLWFuaW1hdG9yLmpzIl0sIm5hbWVzIjpbImpzIiwiY2MiLCJQbGF5YWJsZSIsInJlcXVpcmUiLCJFdmVudEFuaW1DdXJ2ZSIsIkV2ZW50SW5mbyIsIldyYXBNb2RlTWFzayIsImJpbmFyeVNlYXJjaCIsImJpbmFyeVNlYXJjaEVwc2lsb24iLCJBbmltYXRpb25BbmltYXRvciIsInRhcmdldCIsImFuaW1hdGlvbiIsImNhbGwiLCJfYW5pbXMiLCJhcnJheSIsIk11dGFibGVGb3J3YXJkSXRlcmF0b3IiLCJleHRlbmQiLCJwIiwicHJvdG90eXBlIiwicGxheVN0YXRlIiwic3RhdGUiLCJzdGFydFRpbWUiLCJjbGlwIiwiY3VydmVMb2FkZWQiLCJpbml0Q2xpcERhdGEiLCJhbmltYXRvciIsInBsYXkiLCJzZXRUaW1lIiwic3RvcFN0YXRlc0V4Y2VwdCIsIml0ZXJhdG9yIiwiaSIsImxlbmd0aCIsImFuaW0iLCJzdG9wU3RhdGUiLCJhZGRBbmltYXRpb24iLCJpbmRleCIsImluZGV4T2YiLCJwdXNoIiwiX3NldEV2ZW50VGFyZ2V0IiwicmVtb3ZlQW5pbWF0aW9uIiwiZmFzdFJlbW92ZUF0Iiwic3RvcCIsImVycm9ySUQiLCJzYW1wbGUiLCJwYXVzZVN0YXRlIiwicGF1c2UiLCJyZXN1bWVTdGF0ZSIsInJlc3VtZSIsImlzUGF1c2VkIiwic2V0U3RhdGVUaW1lIiwidGltZSIsInVuZGVmaW5lZCIsIm9uU3RvcCIsIm9uUGF1c2UiLCJvblJlc3VtZSIsIl9yZWxvYWRDbGlwIiwiY3JlYXRlQmF0Y2hlZFByb3BlcnR5IiwicHJvcFBhdGgiLCJmaXJzdERvdEluZGV4IiwibWFpblZhbHVlIiwiYW5pbVZhbHVlIiwiY2xvbmUiLCJuZXh0VmFsdWUiLCJsZWZ0SW5kZXgiLCJyaWdodEluZGV4IiwibmV4dE5hbWUiLCJzbGljZSIsImxhc3RQcm9wTmFtZSIsIkNDX1RFU1QiLCJfVGVzdCIsInJvb3QiLCJkdXJhdGlvbiIsInNwZWVkIiwid3JhcE1vZGUiLCJmcmFtZVJhdGUiLCJMb29wIiwicmVwZWF0Q291bnQiLCJJbmZpbml0eSIsImN1cnZlcyIsImNyZWF0ZUN1cnZlcyIsImV2ZW50cyIsIkNDX0VESVRPUiIsImN1cnZlIiwibCIsImV2ZW50RGF0YSIsInJhdGlvIiwiZnJhbWUiLCJldmVudEluZm8iLCJyYXRpb3MiLCJhZGQiLCJmdW5jIiwicGFyYW1zIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLElBQU1BLEVBQUUsR0FBR0MsRUFBRSxDQUFDRCxFQUFkOztBQUNBLElBQU1FLFFBQVEsR0FBR0MsT0FBTyxDQUFDLFlBQUQsQ0FBeEI7O2VBQ3NDQSxPQUFPLENBQUMsb0JBQUQ7SUFBckNDLDBCQUFBQTtJQUFnQkMscUJBQUFBOztBQUN4QixJQUFNQyxZQUFZLEdBQUdILE9BQU8sQ0FBQyxTQUFELENBQVAsQ0FBbUJHLFlBQXhDOztBQUNBLElBQU1DLFlBQVksR0FBR0osT0FBTyxDQUFDLDZCQUFELENBQVAsQ0FBdUNLLG1CQUE1RCxFQUVBOzs7QUFFQSxTQUFTQyxpQkFBVCxDQUE0QkMsTUFBNUIsRUFBb0NDLFNBQXBDLEVBQStDO0FBQzNDVCxFQUFBQSxRQUFRLENBQUNVLElBQVQsQ0FBYyxJQUFkO0FBQ0EsT0FBS0YsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsT0FBS0MsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxPQUFLRSxNQUFMLEdBQWMsSUFBSWIsRUFBRSxDQUFDYyxLQUFILENBQVNDLHNCQUFiLENBQW9DLEVBQXBDLENBQWQ7QUFDSDs7QUFDRGYsRUFBRSxDQUFDZ0IsTUFBSCxDQUFVUCxpQkFBVixFQUE2QlAsUUFBN0I7QUFD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QUFMLEVBQVk7QUFDUkEsUUFBQUEsS0FBSyxHQUFHLElBQUk5RSxjQUFKLEVBQVI7QUFDQThFLFFBQUFBLEtBQUssQ0FBQ3hFLE1BQU4sR0FBZTRELElBQWY7QUFDQVEsUUFBQUEsTUFBTSxDQUFDekMsSUFBUCxDQUFZNkMsS0FBWjtBQUNIOztBQUVELFVBQUlFLFNBQVMsR0FBR0osTUFBTSxDQUFDbEQsQ0FBRCxDQUF0QjtBQUNBLFVBQUl1RCxLQUFLLEdBQUdELFNBQVMsQ0FBQ0UsS0FBVixHQUFrQmxFLEtBQUssQ0FBQ21ELFFBQXBDO0FBRUEsVUFBSWdCLFNBQVMsU0FBYjtBQUNBLFVBQUlwRCxLQUFLLEdBQUc1QixZQUFZLENBQUMyRSxLQUFLLENBQUNNLE1BQVAsRUFBZUgsS0FBZixDQUF4Qjs7QUFDQSxVQUFJbEQsS0FBSyxJQUFJLENBQWIsRUFBZ0I7QUFDWm9ELFFBQUFBLFNBQVMsR0FBR0wsS0FBSyxDQUFDRixNQUFOLENBQWE3QyxLQUFiLENBQVo7QUFDSCxPQUZELE1BR0s7QUFDRG9ELFFBQUFBLFNBQVMsR0FBRyxJQUFJbEYsU0FBSixFQUFaO0FBQ0E2RSxRQUFBQSxLQUFLLENBQUNNLE1BQU4sQ0FBYW5ELElBQWIsQ0FBa0JnRCxLQUFsQjtBQUNBSCxRQUFBQSxLQUFLLENBQUNGLE1BQU4sQ0FBYTNDLElBQWIsQ0FBa0JrRCxTQUFsQjtBQUNIOztBQUVEQSxNQUFBQSxTQUFTLENBQUNFLEdBQVYsQ0FBY0wsU0FBUyxDQUFDTSxJQUF4QixFQUE4Qk4sU0FBUyxDQUFDTyxNQUF4QztBQUNIO0FBQ0o7QUFDSjs7QUFFRCxJQUFJdkIsT0FBSixFQUFhO0FBQ1RuRSxFQUFBQSxFQUFFLENBQUNvRSxLQUFILENBQVM3QyxZQUFULEdBQXdCQSxZQUF4QjtBQUNIOztBQUdEb0UsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEYsaUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcclxuIENvcHlyaWdodCAoYykgMjAxNy0yMDE4IFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLlxyXG5cclxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cclxuXHJcbiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XHJcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcclxuIHdvcmxkd2lkZSwgcm95YWx0eS1mcmVlLCBub24tYXNzaWduYWJsZSwgcmV2b2NhYmxlIGFuZCBub24tZXhjbHVzaXZlIGxpY2Vuc2VcclxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXHJcbiBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXHJcbiB1c2VkIGZvciBkZXZlbG9waW5nIGdhbWVzLiBZb3UgYXJlIG5vdCBncmFudGVkIHRvIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsXHJcbiBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cclxuXHJcbiBUaGUgc29mdHdhcmUgb3IgdG9vbHMgaW4gdGhpcyBMaWNlbnNlIEFncmVlbWVudCBhcmUgbGljZW5zZWQsIG5vdCBzb2xkLlxyXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cclxuXHJcbiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXHJcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcclxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxyXG4gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxyXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcclxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cclxuIFRIRSBTT0ZUV0FSRS5cclxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXHJcblxyXG5jb25zdCBqcyA9IGNjLmpzO1xyXG5jb25zdCBQbGF5YWJsZSA9IHJlcXVpcmUoJy4vcGxheWFibGUnKTtcclxuY29uc3QgeyBFdmVudEFuaW1DdXJ2ZSwgRXZlbnRJbmZvIH0gPSByZXF1aXJlKCcuL2FuaW1hdGlvbi1jdXJ2ZXMnKTtcclxuY29uc3QgV3JhcE1vZGVNYXNrID0gcmVxdWlyZSgnLi90eXBlcycpLldyYXBNb2RlTWFzaztcclxuY29uc3QgYmluYXJ5U2VhcmNoID0gcmVxdWlyZSgnLi4vY29yZS91dGlscy9iaW5hcnktc2VhcmNoJykuYmluYXJ5U2VhcmNoRXBzaWxvbjtcclxuXHJcbi8vIFRoZSBhY3R1YWwgYW5pbWF0b3IgZm9yIEFuaW1hdGlvbiBDb21wb25lbnRcclxuXHJcbmZ1bmN0aW9uIEFuaW1hdGlvbkFuaW1hdG9yICh0YXJnZXQsIGFuaW1hdGlvbikge1xyXG4gICAgUGxheWFibGUuY2FsbCh0aGlzKTtcclxuICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0O1xyXG4gICAgdGhpcy5hbmltYXRpb24gPSBhbmltYXRpb247XHJcblxyXG4gICAgdGhpcy5fYW5pbXMgPSBuZXcganMuYXJyYXkuTXV0YWJsZUZvcndhcmRJdGVyYXRvcihbXSk7XHJcbn1cclxuanMuZXh0ZW5kKEFuaW1hdGlvbkFuaW1hdG9yLCBQbGF5YWJsZSk7XHJcbmxldCBwID0gQW5pbWF0aW9uQW5pbWF0b3IucHJvdG90eXBlO1xyXG5cclxucC5wbGF5U3RhdGUgPSBmdW5jdGlvbiAoc3RhdGUsIHN0YXJ0VGltZSkge1xyXG4gICAgaWYgKCFzdGF0ZS5jbGlwKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghc3RhdGUuY3VydmVMb2FkZWQpIHtcclxuICAgICAgICBpbml0Q2xpcERhdGEodGhpcy50YXJnZXQsIHN0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0ZS5hbmltYXRvciA9IHRoaXM7XHJcbiAgICBzdGF0ZS5wbGF5KCk7XHJcblxyXG4gICAgaWYgKHR5cGVvZiBzdGFydFRpbWUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgc3RhdGUuc2V0VGltZShzdGFydFRpbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucGxheSgpO1xyXG59O1xyXG5cclxucC5zdG9wU3RhdGVzRXhjZXB0ID0gZnVuY3Rpb24gKHN0YXRlKSB7XHJcbiAgICBsZXQgaXRlcmF0b3IgPSB0aGlzLl9hbmltcztcclxuICAgIGxldCBhcnJheSA9IGl0ZXJhdG9yLmFycmF5O1xyXG4gICAgZm9yIChpdGVyYXRvci5pID0gMDsgaXRlcmF0b3IuaSA8IGFycmF5Lmxlbmd0aDsgKytpdGVyYXRvci5pKSB7XHJcbiAgICAgICAgbGV0IGFuaW0gPSBhcnJheVtpdGVyYXRvci5pXTtcclxuICAgICAgICBpZiAoYW5pbSA9PT0gc3RhdGUpIHtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnN0b3BTdGF0ZShhbmltKTtcclxuICAgIH1cclxufTtcclxuXHJcbnAuYWRkQW5pbWF0aW9uID0gZnVuY3Rpb24gKGFuaW0pIHtcclxuICAgIGxldCBpbmRleCA9IHRoaXMuX2FuaW1zLmFycmF5LmluZGV4T2YoYW5pbSk7XHJcbiAgICBpZiAoaW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgdGhpcy5fYW5pbXMucHVzaChhbmltKTtcclxuICAgIH1cclxuXHJcbiAgICBhbmltLl9zZXRFdmVudFRhcmdldCh0aGlzLmFuaW1hdGlvbik7XHJcbn07XHJcblxyXG5wLnJlbW92ZUFuaW1hdGlvbiA9IGZ1bmN0aW9uIChhbmltKSB7XHJcbiAgICBsZXQgaW5kZXggPSB0aGlzLl9hbmltcy5hcnJheS5pbmRleE9mKGFuaW0pO1xyXG4gICAgaWYgKGluZGV4ID49IDApIHtcclxuICAgICAgICB0aGlzLl9hbmltcy5mYXN0UmVtb3ZlQXQoaW5kZXgpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5fYW5pbXMuYXJyYXkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RvcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIGNjLmVycm9ySUQoMzkwNyk7XHJcbiAgICB9XHJcblxyXG4gICAgYW5pbS5hbmltYXRvciA9IG51bGw7XHJcbn07XHJcblxyXG5wLnNhbXBsZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGxldCBpdGVyYXRvciA9IHRoaXMuX2FuaW1zO1xyXG4gICAgbGV0IGFycmF5ID0gaXRlcmF0b3IuYXJyYXk7XHJcbiAgICBmb3IgKGl0ZXJhdG9yLmkgPSAwOyBpdGVyYXRvci5pIDwgYXJyYXkubGVuZ3RoOyArK2l0ZXJhdG9yLmkpIHtcclxuICAgICAgICBsZXQgYW5pbSA9IGFycmF5W2l0ZXJhdG9yLmldO1xyXG4gICAgICAgIGFuaW0uc2FtcGxlKCk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5wLnN0b3BTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkge1xyXG4gICAgaWYgKHN0YXRlKSB7XHJcbiAgICAgICAgc3RhdGUuc3RvcCgpO1xyXG4gICAgfVxyXG59O1xyXG5cclxucC5wYXVzZVN0YXRlID0gZnVuY3Rpb24gKHN0YXRlKSB7XHJcbiAgICBpZiAoc3RhdGUpIHtcclxuICAgICAgICBzdGF0ZS5wYXVzZSgpO1xyXG4gICAgfVxyXG59O1xyXG5cclxucC5yZXN1bWVTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSkge1xyXG4gICAgaWYgKHN0YXRlKSB7XHJcbiAgICAgICAgc3RhdGUucmVzdW1lKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuaXNQYXVzZWQpIHtcclxuICAgICAgICB0aGlzLnJlc3VtZSgpO1xyXG4gICAgfVxyXG59O1xyXG5cclxucC5zZXRTdGF0ZVRpbWUgPSBmdW5jdGlvbiAoc3RhdGUsIHRpbWUpIHtcclxuICAgIGlmICh0aW1lICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBpZiAoc3RhdGUpIHtcclxuICAgICAgICAgICAgc3RhdGUuc2V0VGltZSh0aW1lKTtcclxuICAgICAgICAgICAgc3RhdGUuc2FtcGxlKCk7XHJcbiAgICAgICAgfSAgICBcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHRpbWUgPSBzdGF0ZTtcclxuXHJcbiAgICAgICAgbGV0IGFycmF5ID0gdGhpcy5fYW5pbXMuYXJyYXk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICBsZXQgYW5pbSA9IGFycmF5W2ldO1xyXG4gICAgICAgICAgICBhbmltLnNldFRpbWUodGltZSk7XHJcbiAgICAgICAgICAgIGFuaW0uc2FtcGxlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG5cclxucC5vblN0b3AgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBsZXQgaXRlcmF0b3IgPSB0aGlzLl9hbmltcztcclxuICAgIGxldCBhcnJheSA9IGl0ZXJhdG9yLmFycmF5O1xyXG4gICAgZm9yIChpdGVyYXRvci5pID0gMDsgaXRlcmF0b3IuaSA8IGFycmF5Lmxlbmd0aDsgKytpdGVyYXRvci5pKSB7XHJcbiAgICAgICAgbGV0IGFuaW0gPSBhcnJheVtpdGVyYXRvci5pXTtcclxuICAgICAgICBhbmltLnN0b3AoKTtcclxuICAgIH1cclxufTtcclxuXHJcbnAub25QYXVzZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGxldCBhcnJheSA9IHRoaXMuX2FuaW1zLmFycmF5O1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIGxldCBhbmltID0gYXJyYXlbaV07XHJcbiAgICAgICAgYW5pbS5wYXVzZSgpO1xyXG5cclxuICAgICAgICAvLyBuZWVkIHRvIHVuYmluZCBhbmltYXRvciB0byBhbmltLCBvciBpdCBtYXliZSBjYW5ub3QgYmUgZ2MuXHJcbiAgICAgICAgYW5pbS5hbmltYXRvciA9IG51bGw7XHJcbiAgICB9XHJcbn07XHJcblxyXG5wLm9uUmVzdW1lID0gZnVuY3Rpb24gKCkge1xyXG4gICAgbGV0IGFycmF5ID0gdGhpcy5fYW5pbXMuYXJyYXk7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgbGV0IGFuaW0gPSBhcnJheVtpXTtcclxuICAgICAgICBcclxuICAgICAgICAvLyByZWJpbmQgYW5pbWF0b3IgdG8gYW5pbVxyXG4gICAgICAgIGFuaW0uYW5pbWF0b3IgPSB0aGlzO1xyXG5cclxuICAgICAgICBhbmltLnJlc3VtZSgpO1xyXG4gICAgfVxyXG59O1xyXG5cclxucC5fcmVsb2FkQ2xpcCA9IGZ1bmN0aW9uIChzdGF0ZSkge1xyXG4gICAgaW5pdENsaXBEYXRhKHRoaXMudGFyZ2V0LCBzdGF0ZSk7XHJcbn07XHJcblxyXG4vLyDov5nkuKrmlrnms5XlupTor6XmmK8gU2FtcGxlZEFuaW1DdXJ2ZSDmiY3og73nlKhcclxuZnVuY3Rpb24gY3JlYXRlQmF0Y2hlZFByb3BlcnR5IChwcm9wUGF0aCwgZmlyc3REb3RJbmRleCwgbWFpblZhbHVlLCBhbmltVmFsdWUpIHtcclxuICAgIG1haW5WYWx1ZSA9IG1haW5WYWx1ZS5jbG9uZSgpO1xyXG4gICAgbGV0IG5leHRWYWx1ZSA9IG1haW5WYWx1ZTtcclxuICAgIGxldCBsZWZ0SW5kZXggPSBmaXJzdERvdEluZGV4ICsgMTtcclxuICAgIGxldCByaWdodEluZGV4ID0gcHJvcFBhdGguaW5kZXhPZignLicsIGxlZnRJbmRleCk7XHJcblxyXG4gICAgLy8gc2NhbiBwcm9wZXJ0eSBwYXRoXHJcbiAgICB3aGlsZSAocmlnaHRJbmRleCAhPT0gLTEpIHtcclxuICAgICAgICBsZXQgbmV4dE5hbWUgPSBwcm9wUGF0aC5zbGljZShsZWZ0SW5kZXgsIHJpZ2h0SW5kZXgpO1xyXG4gICAgICAgIG5leHRWYWx1ZSA9IG5leHRWYWx1ZVtuZXh0TmFtZV07XHJcbiAgICAgICAgbGVmdEluZGV4ID0gcmlnaHRJbmRleCArIDE7XHJcbiAgICAgICAgcmlnaHRJbmRleCA9IHByb3BQYXRoLmluZGV4T2YoJy4nLCBsZWZ0SW5kZXgpO1xyXG4gICAgfVxyXG4gICAgbGV0IGxhc3RQcm9wTmFtZSA9IHByb3BQYXRoLnNsaWNlKGxlZnRJbmRleCk7XHJcbiAgICBuZXh0VmFsdWVbbGFzdFByb3BOYW1lXSA9IGFuaW1WYWx1ZTtcclxuXHJcbiAgICByZXR1cm4gbWFpblZhbHVlO1xyXG59XHJcblxyXG5pZiAoQ0NfVEVTVCkge1xyXG4gICAgY2MuX1Rlc3QuY3JlYXRlQmF0Y2hlZFByb3BlcnR5ID0gY3JlYXRlQmF0Y2hlZFByb3BlcnR5O1xyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gaW5pdENsaXBEYXRhIChyb290LCBzdGF0ZSkge1xyXG4gICAgbGV0IGNsaXAgPSBzdGF0ZS5jbGlwO1xyXG5cclxuICAgIHN0YXRlLmR1cmF0aW9uID0gY2xpcC5kdXJhdGlvbjtcclxuICAgIHN0YXRlLnNwZWVkID0gY2xpcC5zcGVlZDtcclxuICAgIHN0YXRlLndyYXBNb2RlID0gY2xpcC53cmFwTW9kZTtcclxuICAgIHN0YXRlLmZyYW1lUmF0ZSA9IGNsaXAuc2FtcGxlO1xyXG5cclxuICAgIGlmICgoc3RhdGUud3JhcE1vZGUgJiBXcmFwTW9kZU1hc2suTG9vcCkgPT09IFdyYXBNb2RlTWFzay5Mb29wKSB7XHJcbiAgICAgICAgc3RhdGUucmVwZWF0Q291bnQgPSBJbmZpbml0eTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHN0YXRlLnJlcGVhdENvdW50ID0gMTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgY3VydmVzID0gc3RhdGUuY3VydmVzID0gY2xpcC5jcmVhdGVDdXJ2ZXMoc3RhdGUsIHJvb3QpO1xyXG5cclxuICAgIC8vIGV2ZW50cyBjdXJ2ZVxyXG5cclxuICAgIGxldCBldmVudHMgPSBjbGlwLmV2ZW50cztcclxuXHJcbiAgICBpZiAoIUNDX0VESVRPUiAmJiBldmVudHMpIHtcclxuICAgICAgICBsZXQgY3VydmU7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gZXZlbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAoIWN1cnZlKSB7XHJcbiAgICAgICAgICAgICAgICBjdXJ2ZSA9IG5ldyBFdmVudEFuaW1DdXJ2ZSgpO1xyXG4gICAgICAgICAgICAgICAgY3VydmUudGFyZ2V0ID0gcm9vdDtcclxuICAgICAgICAgICAgICAgIGN1cnZlcy5wdXNoKGN1cnZlKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IGV2ZW50RGF0YSA9IGV2ZW50c1tpXTtcclxuICAgICAgICAgICAgbGV0IHJhdGlvID0gZXZlbnREYXRhLmZyYW1lIC8gc3RhdGUuZHVyYXRpb247XHJcblxyXG4gICAgICAgICAgICBsZXQgZXZlbnRJbmZvO1xyXG4gICAgICAgICAgICBsZXQgaW5kZXggPSBiaW5hcnlTZWFyY2goY3VydmUucmF0aW9zLCByYXRpbyk7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBldmVudEluZm8gPSBjdXJ2ZS5ldmVudHNbaW5kZXhdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZXZlbnRJbmZvID0gbmV3IEV2ZW50SW5mbygpO1xyXG4gICAgICAgICAgICAgICAgY3VydmUucmF0aW9zLnB1c2gocmF0aW8pO1xyXG4gICAgICAgICAgICAgICAgY3VydmUuZXZlbnRzLnB1c2goZXZlbnRJbmZvKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZXZlbnRJbmZvLmFkZChldmVudERhdGEuZnVuYywgZXZlbnREYXRhLnBhcmFtcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5pZiAoQ0NfVEVTVCkge1xyXG4gICAgY2MuX1Rlc3QuaW5pdENsaXBEYXRhID0gaW5pdENsaXBEYXRhO1xyXG59XHJcblxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBBbmltYXRpb25BbmltYXRvcjtcclxuIl0sInNvdXJjZVJvb3QiOiIvIn0=